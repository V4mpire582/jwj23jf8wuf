if not game:IsLoaded() then
    game.Loaded:Wait()
end

task.wait(0.45)

local SCRIPT_FLAG = '_AVATAR_CHANGER_LOADED_'
if _G[SCRIPT_FLAG] then
    local old = _G[SCRIPT_FLAG]
    if old.cleanup then
        old.cleanup()
    end
end

cloneref = cloneref or function(...) return ... end

local service = setmetatable({}, {
    __index = function(self, name)
        rawset(self, name, cloneref(game:GetService(name)))
        return rawget(self, name)
    end
})

local Players = service.Players
local TweenService = service.TweenService
local HttpService = service.HttpService
local UserInputService = service.UserInputService
local InsertService = service.InsertService

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild('PlayerGui')

local IS_MOBILE = UserInputService.TouchEnabled and not UserInputService.MouseEnabled

local Icons = {
    eye = 'rbxassetid://10723346959',
    eye_off = 'rbxassetid://10723346871',
    minus = 'rbxassetid://10734896206',
    plus = 'rbxassetid://10734924532',
    search = 'rbxassetid://10734943674',
    play = 'rbxassetid://10734923549',
    dice = 'rbxassetid://10723343321',
    rotate = 'rbxassetid://10734940376',
    chevron_left = 'rbxassetid://10709791281',
    chevron_right = 'rbxassetid://10709791437',
    check = 'rbxassetid://10709790644',
    x = 'rbxassetid://10747384394',
    warning = 'rbxassetid://10709753149',
    info = 'rbxassetid://10723415903',
    star = 'rbxassetid://10734898355',
    heart = 'rbxassetid://10723406885',
    heart_off = 'rbxassetid://10723406662',
    home = 'rbxassetid://10723407389',
    users = 'rbxassetid://10747373426',
    user = 'rbxassetid://10747373176',
    settings = 'rbxassetid://10734950309',
    bookmark = 'rbxassetid://10709782154',
    sliders = 'rbxassetid://10734963400',
    refresh = 'rbxassetid://10734933222',
    zoom_in = 'rbxassetid://10734924532',
    zoom_out = 'rbxassetid://10734896206',
    stats = 'rbxassetid://10747372167'
}

local Sounds = {
    transform = 'rbxassetid://642336941',
    ui_toggle = 'rbxassetid://92647604633081',
    click = 'rbxassetid://126347354635406',
    reset = 'rbxassetid://17779566040',
    dice = 'rbxassetid://500839327',
    tab_switch = 'rbxassetid://3428115723',
    button_click = 'rbxassetid://93927627634818',
    favorite = 'rbxassetid://72841109192126',
    unfavorite = 'rbxassetid://122126938667568'
}

local Music = {
    {name = 'Montagem Blue Shirt', id = 'rbxassetid://122203857226173'},
    {name = 'SAVAGE GHOST SLOWED', id = 'rbxassetid://72811197789142'},
    {name = 'MONTAGEM AURA', id = 'rbxassetid://117759015860393'},
    {name = 'GOOD GIRL FUNK', id = 'rbxassetid://123723674864058'},
    {name = 'I Still Think of You', id = 'rbxassetid://86766967120839'},
    {name = 'Shattered Reflections', id = 'rbxassetid://127812909272456'},
    {name = 'Kakusei Erwachen', id = 'rbxassetid://124853612881772'},
    {name = 'Scary Beats For You', id = 'rbxassetid://88456225545062'},
    {name = 'Happy Song', id = 'rbxassetid://1843404009'},
    {name = 'The Cult', id = 'rbxassetid://98183757946208'},
    {name = 'Windows To The Sun', id = 'rbxassetid://119384335997294'},
    {name = 'SIGMA BOY', id = 'rbxassetid://109420952262721'},
    {name = 'Evangelion Sword Outro', id = 'rbxassetid://102468604705752'},
    {name = 'Christmas Anime Opening', id = 'rbxassetid://112881604345924'},
    {name = 'Kieta Hoshi', id = 'rbxassetid://88704298134223'},
    {name = 'Rise to the Horizon', id = 'rbxassetid://72573266268313'},
    {name = 'Fading Memories', id = 'rbxassetid://87065827699369'},
    {name = 'Kimi no Kodou', id = 'rbxassetid://127296569646417'},
    {name = 'Moeru Kodou', id = 'rbxassetid://138614247392811'},
    {name = 'Kienai Koe', id = 'rbxassetid://90588286632687'},
    {name = 'Saigo no Yakusoku', id = 'rbxassetid://87102415343081'},
    {name = 'Menta Ma', id = 'rbxassetid://98337901681441'},
    {name = 'Tsuko G - Deja Vu', id = 'rbxassetid://16831106636'},
    {name = 'Jumpstyle', id = 'rbxassetid://1839246711'},
    {name = 'Total Confusion', id = 'rbxassetid://103419239604004'},
    {name = 'Run Away', id = 'rbxassetid://128118999630439'},
    {name = 'Hold On (Speed Up)', id = 'rbxassetid://71045969776776'},
    {name = 'United No Borders', id = 'rbxassetid://134841562378374'},
    {name = 'Dear Lana', id = 'rbxassetid://119589412825080'},
    {name = 'Woo Woo Woo Woo', id = 'rbxassetid://77139878722989'},
    {name = 'Clair De Lune', id = 'rbxassetid://1838457617'},
    {name = 'ORAY BEY FUNK', id = 'rbxassetid://135286582331883'},
    {name = 'Nocturne', id = 'rbxassetid://129108903964685'},
    {name = 'Hide & Seek', id = 'rbxassetid://131571387429103'},
    {name = 'ã‚­ãƒ©ãƒ¡ã‚­âˆžãƒ«ãƒ¼ãƒ—', id = 'rbxassetid://108849060438649'},
    {name = 'Banana Bashin', id = 'rbxassetid://118231802185865'}
}

local C = {
    base = Color3.fromRGB(12, 12, 16),
    panel = Color3.fromRGB(18, 18, 24),
    card = Color3.fromRGB(26, 26, 34),
    elevated = Color3.fromRGB(36, 36, 46),
    hover = Color3.fromRGB(46, 46, 58),
    border = Color3.fromRGB(55, 55, 70),
    text = Color3.fromRGB(255, 255, 255),
    subtext = Color3.fromRGB(180, 180, 195),
    muted = Color3.fromRGB(100, 100, 120),
    accent = Color3.fromRGB(99, 102, 241),
    accent_glow = Color3.fromRGB(129, 132, 255),
    success = Color3.fromRGB(34, 197, 94),
    error = Color3.fromRGB(239, 68, 68),
    warning = Color3.fromRGB(245, 158, 11),
    star = Color3.fromRGB(255, 200, 50)
}

local TRANSPARENCY = 0.22

local Presets = {
   289438135, 1707711223, 188732, 2298753899, 9119588309, 5254879171, 8595350470, 6007609888, 124751865, 5019714978, 5007631110, 9088628683, 7223875998, 2474943274, 3104949425, 3335871296, 203030608, 2596305840, 201124389, 1981724228, 3731169417, 205419201, 7422492329, 406436524, 1803380, 4241434815, 9406742928, 1359861204, 3012958642, 2260118449, 188829949, 2261820401, 8094705681, 9894023718, 6077615334, 2281971469, 1946404863, 660132420, 1125262365, 3018607207, 144018186, 3577671250, 2017401176, 3473976672, 9122248242, 1667867130, 9294642379, 5366504429, 8264800124, 283156132, 1630540916, 4416918097, 344091683, 6538096, 7623744992, 1099702304, 1199088309, 1369842558, 3624257547
}

local State = {
    applying = false,
    auto = false,
    applied_id = nil,
    minimized = false,
    visible = true,
    preview_open = false,
    client_preview_open = false,
    cache = {},
    randoms = {},
    conns = {},
    original_desc = nil,
    input_ready = false,
    random_cooldown = false,
    fab_toggle_cooldown = false,
    favorites = {},
    current_tab = 'main',
    fav_name_cache = {},
    width_scale = 1,
    width_enabled = false,
    client_applying = false,
    player_original_descs = {},
    fav_search_text = '',
    zoom_level = 5.5,
    client_zoom_level = 5.5,
    avatar_details = {},
    height_scale = 1,
    height_enabled = false,
    depth_scale = 1,
    depth_enabled = false,
    music_playing = false,
    music_index = 1,
    music_sound = nil,
    music_loop = false,
    sound_effects_enabled = true,
    apply_counts = {},
    stats_apply_cooldown = false
}

local E = {}
local file = '__Avatar___Changer__.json'

local function tween(obj, props, dur, style, dir)
    local t = TweenService:Create(
        obj,
        TweenInfo.new(dur or 0.2, style or Enum.EasingStyle.Quint, dir or Enum.EasingDirection.Out),
        props
    )
    t:Play()
    return t
end

local function spring(obj, props, dur)
    return tween(obj, props, dur or 0.25, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
end

local function new(class, props)
    local obj = Instance.new(class)
    for k, v in pairs(props) do
        if k ~= 'Parent' then
            obj[k] = v
        end
    end
    if props.Parent then
        obj.Parent = props.Parent
    end
    return obj
end

local function corner(p, r)
    return new('UICorner', {
        CornerRadius = UDim.new(0, r or 8),
        Parent = p
    })
end

local function stroke(p, c, t, trans)
    return new('UIStroke', {
        Color = c or C.border,
        Thickness = t or 1,
        Transparency = trans or 0.5,
        Parent = p
    })
end

local function icon(parent, id, size, color, position)
    return new('ImageLabel', {
        Size = UDim2.new(0, size or 16, 0, size or 16),
        Position = position or UDim2.new(0.5, -(size or 16) / 2, 0.5, -(size or 16) / 2),
        BackgroundTransparency = 1,
        Image = id,
        ImageColor3 = color or C.text,
        Parent = parent
    })
end

local function save_data()
    if not writefile then
        return
    end
    pcall(writefile, file, HttpService:JSONEncode({
        input = E.input and E.input.Text or '',
        auto = State.auto,
        minimized = State.minimized,
        visible = State.visible,
        x = E.main and E.main.Position.X.Offset,
        y = E.main and E.main.Position.Y.Offset,
        fab_x = E.fab and E.fab.Position.X.Offset,
        fab_y = E.fab and E.fab.Position.Y.Offset,
        favorites = State.favorites,
        width_scale = State.width_scale,
        width_enabled = State.width_enabled,
        height_scale = State.height_scale,
        height_enabled = State.height_enabled,
        depth_scale = State.depth_scale,
        depth_enabled = State.depth_enabled,
        music_index = State.music_index,
        music_loop = State.music_loop,
        sound_effects_enabled = State.sound_effects_enabled,
        apply_counts = State.apply_counts
    }))
end

local function load_data()
    if not readfile then
        return {}
    end
    local ok, d = pcall(function()
        return HttpService:JSONDecode(readfile(file))
    end)
    return ok and d or {}
end

local function play_sound(sound_id)
    if not State.sound_effects_enabled then
        return
    end
    pcall(function()
        local sound = Instance.new('Sound')
        sound.SoundId = sound_id
        sound.Volume = 0.5
        sound.Parent = workspace
        sound:Play()
        task.delay(2, function()
            sound:Destroy()
        end)
    end)
end

local function resolve(txt)
    if not txt or txt == '' then
        return nil
    end
    txt = txt:match('^%s*(.-)%s*$')
    if tonumber(txt) then
        return tonumber(txt)
    end
    local ok, id = pcall(Players.GetUserIdFromNameAsync, Players, txt)
    return ok and id or nil
end

local function clamp_frame(frame, avoid_overlap)
    local vp = workspace.CurrentCamera.ViewportSize
    local s = frame.AbsoluteSize
    local x = math.clamp(frame.Position.X.Offset, 10, vp.X - s.X - 10)
    local y = math.clamp(frame.Position.Y.Offset, 10, vp.Y - s.Y - 10)
    
    if avoid_overlap and State.preview_open and E.preview and E.preview.Visible then
        local prev_x = E.preview.Position.X.Offset
        local prev_y = E.preview.Position.Y.Offset
        local prev_w = 210
        local prev_h = 340
        local main_right = x + s.X
        local main_bottom = y + s.Y
        local prev_right = prev_x + prev_w
        local prev_bottom = prev_y + prev_h
        
        if x < prev_right and main_right > prev_x and y < prev_bottom and main_bottom > prev_y then
            local left_x = prev_x - s.X - 12
            if left_x >= 10 then
                x = left_x
            else
                local right_x = prev_right + 12
                if right_x + s.X <= vp.X - 10 then
                    x = right_x
                else
                    local above_y = prev_y - s.Y - 12
                    local below_y = prev_bottom + 12
                    if above_y >= 10 then
                        y = above_y
                    elseif below_y + s.Y <= vp.Y - 10 then
                        y = below_y
                    end
                end
            end
        end
    end
    return UDim2.new(0, x, 0, y)
end

local function cleanup_all()
    for _, conn in ipairs(State.conns) do
        if conn and conn.Connected then
            conn:Disconnect()
        end
    end
    State.conns = {}
    
    if State.music_sound then
        State.music_sound:Stop()
        State.music_sound:Destroy()
        State.music_sound = nil
    end
    
    if State.original_desc and State.applied_id then
        local char = LocalPlayer.Character
        if char then
            local hum = char:FindFirstChildOfClass('Humanoid')
            if hum then
                pcall(function()
                    if hum.ApplyDescriptionClientServer then
                        hum:ApplyDescriptionClientServer(State.original_desc)
                    else
                        hum:ApplyDescription(State.original_desc)
                    end
                end)
            end
        end
    end
    
    if E.screen then
        E.screen:Destroy()
    end
    
    State.applied_id = nil
end

_G[SCRIPT_FLAG] = {
    cleanup = cleanup_all,
    state = State
}

local Notify = {}
Notify.list = {}

function Notify.show(msg, ntype, dur)
    dur = dur or 3
    local color = C.accent
    local ico = Icons.info
    
    if ntype == 'success' then
        color = C.success
        ico = Icons.check
    elseif ntype == 'error' then
        color = C.error
        ico = Icons.x
    elseif ntype == 'warning' then
        color = C.warning
        ico = Icons.warning
    end
    
    local container = new('Frame', {
        Size = UDim2.new(0, 300, 0, 0),
        Position = UDim2.new(1, -315, 1, -15 - (#Notify.list * 75)),
        AnchorPoint = Vector2.new(0, 1),
        BackgroundColor3 = C.panel,
        BackgroundTransparency = TRANSPARENCY,
        ClipsDescendants = true,
        Parent = E.screen
    })
    corner(container, 12)
    stroke(container, color, 1.5, 0.3)
    
    new('Frame', {
        Size = UDim2.new(0, 4, 1, -16),
        Position = UDim2.new(0, 12, 0, 8),
        BackgroundColor3 = color,
        Parent = container
    })
    
    local icon_bg = new('Frame', {
        Size = UDim2.new(0, 36, 0, 36),
        Position = UDim2.new(0, 26, 0.5, -18),
        BackgroundColor3 = color,
        BackgroundTransparency = 0.85,
        Parent = container
    })
    corner(icon_bg, 10)
    icon(icon_bg, ico, 18, color)
    
    local titles = {
        success = 'Success',
        error = 'Error',
        warning = 'Warning',
        info = 'Info'
    }
    
    new('TextLabel', {
        Size = UDim2.new(1, -85, 0, 16),
        Position = UDim2.new(0, 72, 0, 14),
        BackgroundTransparency = 1,
        Text = titles[ntype] or titles.info,
        TextColor3 = color,
        Font = Enum.Font.GothamBold,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = container
    })
    
    new('TextLabel', {
        Size = UDim2.new(1, -85, 0, 18),
        Position = UDim2.new(0, 72, 0, 32),
        BackgroundTransparency = 1,
        Text = msg,
        TextColor3 = C.text,
        Font = Enum.Font.GothamMedium,
        TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd,
        Parent = container
    })
    
    local prog_bg = new('Frame', {
        Size = UDim2.new(1, -24, 0, 3),
        Position = UDim2.new(0, 12, 1, -10),
        BackgroundColor3 = C.card,
        Parent = container
    })
    corner(prog_bg, 2)
    
    local prog = new('Frame', {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = color,
        Parent = prog_bg
    })
    corner(prog, 2)
    
    table.insert(Notify.list, container)
    spring(container, { Size = UDim2.new(0, 300, 0, 70) }, 0.25)
    tween(prog, { Size = UDim2.new(0, 0, 1, 0) }, dur, Enum.EasingStyle.Linear)
    
    task.delay(dur, function()
        tween(container, { Size = UDim2.new(0, 300, 0, 0), BackgroundTransparency = 1 }, 0.2)
        task.delay(0.25, function()
            for i, n in ipairs(Notify.list) do
                if n == container then
                    table.remove(Notify.list, i)
                    break
                end
            end
            container:Destroy()
            for i, n in ipairs(Notify.list) do
                tween(n, { Position = UDim2.new(1, -315, 1, -15 - ((i - 1) * 75)) }, 0.2)
            end
        end)
    end)
end

local Fav = {}
Fav.removing = false

function Fav.is_favorited(id)
    for _, fav in ipairs(State.favorites) do
        if fav.id == id then
            return true
        end
    end
    return false
end

function Fav.update_star_icon()
    if not E.star_icon then
        return
    end
    if State.applied_id and Fav.is_favorited(State.applied_id) then
        E.star_icon.Image = Icons.heart
        tween(E.star_icon, { ImageColor3 = Color3.fromRGB(239, 68, 68) }, 0.15)
    else
        E.star_icon.Image = Icons.heart_off
        tween(E.star_icon, { ImageColor3 = C.subtext }, 0.15)
    end
end

function Fav.add(id)
    if Fav.is_favorited(id) then
        return
    end
    local name
    local ok, n = pcall(Players.GetNameFromUserIdAsync, Players, id)
    name = ok and n or tostring(id)
    table.insert(State.favorites, {id = id, name = name, time = os.time()})
    save_data()
    if State.current_tab == 'favorites' then
        Fav.update_ui()
    end
    play_sound(Sounds.favorite)
    Notify.show('Added To Favorites!', 'success', 2)
    Fav.update_star_icon()
end

function Fav.remove(id)
    if Fav.removing then
        return
    end
    Fav.removing = true
    
    for i, fav in ipairs(State.favorites) do
        if fav.id == id then
            table.remove(State.favorites, i)
            save_data()
            Fav.update_ui()
            play_sound(Sounds.unfavorite)
            Notify.show('Removed From Favorites', 'info', 2)
            task.delay(0.2, function() Fav.removing = false end)
            Fav.update_star_icon()
            return
        end
    end
    Fav.removing = false
end

function Fav.toggle(id)
    if Fav.is_favorited(id) then
        Fav.remove(id)
    else
        Fav.add(id)
    end
end

local Av = {}

function Fav.update_ui()
    if not E.fav_list then
        return
    end
    
    for _, child in ipairs(E.fav_list:GetChildren()) do
        if child:IsA('Frame') or child:IsA('TextLabel') then
            child:Destroy()
        end
    end
    
    local filtered_favorites = {}
    local search_lower = State.fav_search_text:lower()
    
    for _, fav in ipairs(State.favorites) do
        if search_lower == '' or 
           fav.name:lower():find(search_lower, 1, true) or 
           tostring(fav.id):find(search_lower, 1, true) then
            table.insert(filtered_favorites, fav)
        end
    end
    
    if #filtered_favorites == 0 then
        local empty_text = #State.favorites == 0 and
            'â­ No Favorites Yet!\nApply An Avatar And Click\nThe Button To Save It' or
            'ðŸ” No Matches Found\nTry A Different Search'
        
        new('TextLabel', {
            Size = UDim2.new(1, 0, 0, 100),
            BackgroundTransparency = 1,
            Text = empty_text,
            TextColor3 = C.muted,
            Font = Enum.Font.GothamMedium,
            TextSize = 13,
            Parent = E.fav_list
        })
        E.fav_list.CanvasSize = UDim2.new(0, 0, 0, 100)
        return
    end
    
    local total_height = 0
    for i = #filtered_favorites, 1, -1 do
        local fav = filtered_favorites[i]
        
        local item = new('Frame', {
            Size = UDim2.new(1, -6, 0, 68),
            BackgroundColor3 = C.elevated,
            Parent = E.fav_list
        })
        corner(item, 12)
        stroke(item, C.border, 1, 0.3)
        
        new('TextLabel', {
            Size = UDim2.new(1, -140, 0, 20),
            Position = UDim2.new(0, 16, 0, 12),
            BackgroundTransparency = 1,
            Text = fav.name,
            TextColor3 = C.text,
            Font = Enum.Font.GothamBold,
            TextSize = 14,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextTruncate = Enum.TextTruncate.AtEnd,
            Parent = item
        })
        
        new('TextLabel', {
            Size = UDim2.new(1, -140, 0, 16),
            Position = UDim2.new(0, 16, 0, 36),
            BackgroundTransparency = 1,
            Text = 'ID: ' .. tostring(fav.id),
            TextColor3 = C.muted,
            Font = Enum.Font.GothamMedium,
            TextSize = 12,
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = item
        })
        
        local apply_btn = new('TextButton', {
            Size = UDim2.new(0, 70, 0, 50),
            Position = UDim2.new(1, -120, 0.5, -25),
            BackgroundColor3 = C.accent,
            Text = '',
            AutoButtonColor = false,
            Parent = item
        })
        corner(apply_btn, 10)
        
        new('TextLabel', {
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Text = 'APPLY',
            TextColor3 = C.text,
            Font = Enum.Font.GothamBold,
            TextSize = 12,
            Parent = apply_btn
        })
        
        apply_btn.MouseEnter:Connect(function() tween(apply_btn, { BackgroundColor3 = C.accent_glow }, 0.1) end)
        apply_btn.MouseLeave:Connect(function() tween(apply_btn, { BackgroundColor3 = C.accent }, 0.1) end)
        
        local captured_id = fav.id
        apply_btn.InputBegan:Connect(function(inp)
            if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
                E.input.Text = tostring(captured_id)
                E.switch_tab('main')
                Av.apply(tostring(captured_id))
            end
        end)
        
        local remove_btn = new('TextButton', {
            Size = UDim2.new(0, 36, 0, 50),
            Position = UDim2.new(1, -44, 0.5, -25),
            BackgroundColor3 = C.card,
            Text = '',
            AutoButtonColor = false,
            Parent = item
        })
        corner(remove_btn, 10)
        icon(remove_btn, Icons.x, 16, C.subtext)
        
        remove_btn.MouseEnter:Connect(function() tween(remove_btn, { BackgroundColor3 = C.hover }, 0.1) end)
        remove_btn.MouseLeave:Connect(function() tween(remove_btn, { BackgroundColor3 = C.card }, 0.1) end)
        
        local captured_id_remove = fav.id
        remove_btn.InputBegan:Connect(function(inp)
            if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
                Fav.remove(captured_id_remove)
            end
        end)
        
        total_height = total_height + 78
    end
    
    E.fav_list.CanvasSize = UDim2.new(0, 0, 0, total_height)
end

local Prev = {
    rot = 180,
    model = nil,
    cam = nil,
    world = nil,
    loading = false,
    current_id = nil,
    load_token = 0
}

function Prev.clear()
    if Prev.model then
        Prev.model:Destroy() Prev.model = nil
    end
    if Prev.cam then
        Prev.cam:Destroy() Prev.cam = nil
    end
    if Prev.world then
        Prev.world:Destroy() Prev.world = nil
    end
    Prev.rot = 180
    Prev.current_id = nil
end

function Prev.update()
    if not Prev.cam or not Prev.model then
        return
    end
    local root = Prev.model:FindFirstChild('HumanoidRootPart')
    if not root then
        return
    end
    local a = math.rad(Prev.rot)
    local zoom = State.zoom_level
    Prev.cam.CFrame = CFrame.new(
        root.Position + Vector3.new(math.sin(a) * zoom, 0.4, math.cos(a) * zoom),
        root.Position + Vector3.new(0, 0.2, 0)
    )
end

function Prev.load(target)
    Prev.load_token = Prev.load_token + 1
    local this_token = Prev.load_token
    
    if not target or target == '' then
        Prev.clear()
        E.vp_label.Text = 'Enter ID'
        E.vp_label.Visible = true
        E.vp_user.Text = ''
        return
    end
    
    local id = resolve(target)
    if not id then
        Prev.clear()
        E.vp_label.Text = 'Not Found'
        E.vp_label.Visible = true
        E.vp_user.Text = ''
        return
    end
    
    if Prev.current_id == id and not Prev.loading then
        return
    end
    
    E.vp_label.Text = 'Loading...'
    E.vp_label.Visible = true
    E.vp_user.Text = ''
    
    task.spawn(function()
        if Prev.load_token ~= this_token then
            return
        end
        Prev.clear()
        Prev.loading = true
        Prev.current_id = id
        
        local ok, name = pcall(Players.GetNameFromUserIdAsync, Players, id)
        if Prev.load_token ~= this_token then
            Prev.loading = false return
        end
        E.vp_user.Text = ok and name or tostring(id)
        
        local cok, char = pcall(Players.CreateHumanoidModelFromUserId, Players, id)
        if Prev.load_token ~= this_token then
            if char then
                char:Destroy()
            end
            Prev.loading = false
            return
        end
        
        if not cok or not char then
            E.vp_label.Text = 'Failed'
            Prev.loading = false
            Prev.current_id = nil
            return
        end
        
        Prev.world = Instance.new('WorldModel')
        Prev.world.Parent = E.viewport
        Prev.model = char
        Prev.model.Parent = Prev.world
        
        local hum = Prev.model:FindFirstChildOfClass('Humanoid')
        if hum then
            hum.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.None
        end
        
        local root = Prev.model:FindFirstChild('HumanoidRootPart')
        if root then
            root.Anchored = true
            Prev.model.PrimaryPart = root
            root.CFrame = CFrame.new(0, 0, 0)
        end
        
        Prev.cam = Instance.new('Camera')
        Prev.cam.Parent = E.viewport
        E.viewport.CurrentCamera = Prev.cam
        Prev.rot = 180
        Prev.update()
        E.vp_label.Visible = false
        Prev.loading = false
        
        local rig_type = 'R15'
        if hum then
            if hum.RigType == Enum.HumanoidRigType.R6 then
                rig_type = 'R6'
            end
        end
        
        State.avatar_details[id] = {
            username = ok and name or tostring(id),
            rig_type = rig_type,
            user_id = id
        }
        
        if E.vp_details then
            E.vp_details.Text = string.format('%s â€¢ %s', rig_type, ok and name or tostring(id))
        end
        
        task.spawn(function()
            if Prev.load_token ~= this_token or not Prev.model then
                return
            end
            for _, o in ipairs(Prev.model:GetChildren()) do
                if o:IsA('Shirt') then
                    local t = o.ShirtTemplate
                    o.ShirtTemplate = ''
                    o.ShirtTemplate = t
                elseif o:IsA('Pants') then
                    local t = o.PantsTemplate
                    o.PantsTemplate = ''
                    o.PantsTemplate = t
                end
            end
        end)
    end)
end

local ClientPrev = {
    rot = 180,
    model = nil,
    cam = nil,
    world = nil,
    loading = false,
    current_id = nil,
    load_token = 0
}

function ClientPrev.clear()
    if ClientPrev.model then
        ClientPrev.model:Destroy() ClientPrev.model = nil
    end
    if ClientPrev.cam then
        ClientPrev.cam:Destroy() ClientPrev.cam = nil
    end
    if ClientPrev.world then
        ClientPrev.world:Destroy() ClientPrev.world = nil
    end
    ClientPrev.rot = 180
    ClientPrev.current_id = nil
end

function ClientPrev.update()
    if not ClientPrev.cam or not ClientPrev.model then
        return
    end
    local root = ClientPrev.model:FindFirstChild('HumanoidRootPart')
    if not root then
        return
    end
    local a = math.rad(ClientPrev.rot)
    local zoom = State.client_zoom_level
    ClientPrev.cam.CFrame = CFrame.new(
        root.Position + Vector3.new(math.sin(a) * zoom, 0.4, math.cos(a) * zoom),
        root.Position + Vector3.new(0, 0.2, 0)
    )
end

function ClientPrev.load(target)
    ClientPrev.load_token = ClientPrev.load_token + 1
    local this_token = ClientPrev.load_token
    
    if not target or target == '' then
        ClientPrev.clear()
        if E.client_vp_label then
            E.client_vp_label.Text = 'Enter ID'
            E.client_vp_label.Visible = true
        end
        if E.client_vp_user then
            E.client_vp_user.Text = ''
        end
        return
    end
    
    local id = resolve(target)
    if not id then
        ClientPrev.clear()
        if E.client_vp_label then
            E.client_vp_label.Text = 'Not Found'
            E.client_vp_label.Visible = true
        end
        if E.client_vp_user then
            E.client_vp_user.Text = ''
        end
        return
    end
    
    if ClientPrev.current_id == id and not ClientPrev.loading then
        return
    end
    
    if E.client_vp_label then
        E.client_vp_label.Text = 'Loading...'
        E.client_vp_label.Visible = true
    end
    if E.client_vp_user then
        E.client_vp_user.Text = ''
    end
    
    task.spawn(function()
        if ClientPrev.load_token ~= this_token then
            return
        end
        ClientPrev.clear()
        ClientPrev.loading = true
        ClientPrev.current_id = id
        
        local ok, name = pcall(Players.GetNameFromUserIdAsync, Players, id)
        if ClientPrev.load_token ~= this_token then
            ClientPrev.loading = false return
        end
        if E.client_vp_user then
            E.client_vp_user.Text = ok and name or tostring(id)
        end
        
        local cok, char = pcall(Players.CreateHumanoidModelFromUserId, Players, id)
        if ClientPrev.load_token ~= this_token then
            if char then
                char:Destroy()
            end
            ClientPrev.loading = false
            return
        end
        
        if not cok or not char then
            if E.client_vp_label then
                E.client_vp_label.Text = 'Failed'
            end
            ClientPrev.loading = false
            ClientPrev.current_id = nil
            return
        end
        
        ClientPrev.world = Instance.new('WorldModel')
        ClientPrev.world.Parent = E.client_viewport
        ClientPrev.model = char
        ClientPrev.model.Parent = ClientPrev.world
        
        local hum = ClientPrev.model:FindFirstChildOfClass('Humanoid')
        if hum then
            hum.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.None
        end
        
        local root = ClientPrev.model:FindFirstChild('HumanoidRootPart')
        if root then
            root.Anchored = true
            ClientPrev.model.PrimaryPart = root
            root.CFrame = CFrame.new(0, 0, 0)
        end
        
        ClientPrev.cam = Instance.new('Camera')
        ClientPrev.cam.Parent = E.client_viewport
        E.client_viewport.CurrentCamera = ClientPrev.cam
        ClientPrev.rot = 180
        ClientPrev.update()
        if E.client_vp_label then
            E.client_vp_label.Visible = false
        end
        ClientPrev.loading = false
        
        task.spawn(function()
            if ClientPrev.load_token ~= this_token or not ClientPrev.model then
                return
            end
            for _, o in ipairs(ClientPrev.model:GetChildren()) do
                if o:IsA('Shirt') then
                    local t = o.ShirtTemplate
                    o.ShirtTemplate = ''
                    o.ShirtTemplate = t
                elseif o:IsA('Pants') then
                    local t = o.PantsTemplate
                    o.PantsTemplate = ''
                    o.PantsTemplate = t
                end
            end
        end)
    end)
end

function Av.get_desc(id)
    if State.cache[id] then
        return State.cache[id]
    end
    local ok, desc = pcall(Players.GetHumanoidDescriptionFromUserId, Players, id)
    if ok and desc then
        State.cache[id] = desc
        return desc
    end
    return nil
end

function Av.load_asset(id)
    local ok, m = pcall(InsertService.LoadAsset, InsertService, id)
    return ok and m and m:GetChildren()[1] or nil
end

function Av.build_allowed_from_userid(userId)
    local ok, model = pcall(function()
        return Players:GetCharacterAppearanceAsync(userId)
    end)
    if not ok or not model then
        return nil
    end
    local allowedAccessories = {}
    local allowedShirt, allowedPants, allowedGraphic
    for _, inst in ipairs(model:GetChildren()) do
        if inst:IsA('Accessory') then
            allowedAccessories[inst.Name] = true
        elseif inst:IsA('Shirt') then
            allowedShirt = inst.ShirtTemplate
        elseif inst:IsA('Pants') then
            allowedPants = inst.PantsTemplate
        elseif inst:IsA('ShirtGraphic') then
            allowedGraphic = inst.Graphic
        end
    end
    model:Destroy()
    return {
        Accessories = allowedAccessories,
        Shirt = allowedShirt,
        Pants = allowedPants,
        Graphic = allowedGraphic,
    }
end

function Av.selective_cleanup(Character, allowed)
    if not allowed then
        return
    end
    for _, v in ipairs(Character:GetChildren()) do
        if v:IsA('Accessory') then
            if not allowed.Accessories[v.Name] then
                v:Destroy()
            end
        elseif v:IsA('Shirt') then
            if not allowed.Shirt or v.ShirtTemplate ~= allowed.Shirt then
                v:Destroy()
            end
        elseif v:IsA('Pants') then
            if not allowed.Pants or v.PantsTemplate ~= allowed.Pants then
                v:Destroy()
            end
        elseif v:IsA('ShirtGraphic') then
            if not allowed.Graphic or v.Graphic ~= allowed.Graphic then
                v:Destroy()
            end
        end
    end
end

function Av.clean(char)
    local safe = {}
    for _, o in ipairs(char:GetDescendants()) do
        if o:IsA('BaseScript') then
            safe[o] = true
            if o.Parent then
                safe[o.Parent] = true
            end
        end
    end
    for _, c in ipairs(char:GetChildren()) do
        if c:IsA('Tool') or c:IsA('HopperBin') then
            safe[c] = true
        end
    end
    for _, c in ipairs(char:GetChildren()) do
        if safe[c] then
            continue
        end
        if c:IsA('Accessory') or c:IsA('Hat') or c:IsA('BodyColors') or c:IsA('CharacterMesh') or c:IsA('Shirt') or c:IsA('Pants') or c:IsA('ShirtGraphic') then
            c:Destroy()
        end
    end
end

function Av.apply_body_scales(char)
    if not char then
        char = LocalPlayer.Character
    end
    if not char then
        return
    end
    
    local hum = char:FindFirstChildOfClass('Humanoid')
    if not hum then
        return
    end
    
    local desc = hum:GetAppliedDescription()
    if not desc then
        return
    end
    
    local changed = false
    
    if State.width_enabled then
        desc.WidthScale = State.width_scale
        changed = true
    end
    
    if State.height_enabled then
        desc.HeightScale = State.height_scale
        changed = true
    end
    
    if State.depth_enabled then
        desc.DepthScale = State.depth_scale
        changed = true
    end
    
    if changed then
        pcall(function()
            if hum.ApplyDescriptionClientServer then
                hum:ApplyDescriptionClientServer(desc)
            else
                hum:ApplyDescription(desc)
            end
        end)
    end
end

function Av.apply(target, targetChar)
    if State.applying then
        return
    end
    State.applying = true
    
    task.spawn(function()
        local id = resolve(target)
        if not id then
            State.applying = false
            Notify.show('User Not Found', 'error')
            return
        end
        
        local char = targetChar or LocalPlayer.Character
        if not char or not char:FindFirstChild('HumanoidRootPart') then
            State.applying = false
            return
        end
        
        if not targetChar and State.applied_id == id then
            State.applying = false
            Notify.show('Avatar Already Applied', 'warning')
            return
        end
        
        local desc = Av.get_desc(id)
        if not desc then
            State.applying = false
            Notify.show('Failed To Fetch', 'error')
            return
        end
        
        local hum = char:FindFirstChildOfClass('Humanoid')
        if not hum then
            State.applying = false
            return
        end
        
        if not targetChar and not State.original_desc then
            local original_desc = hum:GetAppliedDescription()
            if original_desc then
                State.original_desc = original_desc
            end
        end
        
        local tools = {}
        for _, c in ipairs(char:GetChildren()) do
            if c:IsA('Tool') then
                table.insert(tools, c)
            end
        end
        
        local backpack = char.Parent and char.Parent:FindFirstChild('Backpack')
        if backpack then
            for _, t in ipairs(backpack:GetChildren()) do
                if t:IsA('Tool') then
                    table.insert(tools, t)
                end
            end
        end
        
        local allowed = Av.build_allowed_from_userid(id)
        if allowed then
            Av.selective_cleanup(char, allowed)
        else
            Av.clean(char)
        end
        
        pcall(function()
            if hum.ApplyDescriptionClientServer then
                hum:ApplyDescriptionClientServer(desc)
            else
                hum:ApplyDescription(desc)
            end
        end)
        
        for _, t in ipairs(tools) do
            if t and t.Parent == nil then
                if backpack then
                    t.Parent = backpack
                else
                    t.Parent = char
                end
            end
        end
        
        local bc = char:FindFirstChildOfClass('BodyColors')
        if not bc then
            bc = Instance.new('BodyColors')
            bc.Parent = char
        end
        
        bc.HeadColor3 = desc.HeadColor
        bc.TorsoColor3 = desc.TorsoColor
        bc.LeftArmColor3 = desc.LeftArmColor
        bc.RightArmColor3 = desc.RightArmColor
        bc.LeftLegColor3 = desc.LeftLegColor
        bc.RightLegColor3 = desc.RightLegColor
        
        local fields = {
            'HatAccessory', 'HairAccessory', 'FaceAccessory', 'NeckAccessory',
            'FrontAccessory', 'BackAccessory', 'WaistAccessory'
        }
        
        local total, loaded = 0, 0
        for _, f in ipairs(fields) do
            if desc[f] and desc[f] ~= '' then
                for _ in string.gmatch(desc[f], '%d+') do total = total + 1 end
            end
        end
        
        for _, f in ipairs(fields) do
            if desc[f] and desc[f] ~= '' then
                for aid in string.gmatch(desc[f], '%d+') do
                    task.spawn(function()
                        local acc = Av.load_asset(tonumber(aid))
                        if acc and acc:IsA('Accessory') then
                            acc.Parent = char
                            hum:AddAccessory(acc)
                        end
                        loaded = loaded + 1
                    end)
                end
            end
        end
        
        local t = 0
        while loaded < total and t < 2 do
            task.wait(0.02)
            t = t + 0.02
        end
        
        if not targetChar then
            State.applied_id = id
            State.apply_counts[tostring(id)] = (State.apply_counts[tostring(id)] or 0) + 1
            save_data()
            Av.apply_body_scales(char)
            Av.protect(char, id)
            Fav.update_star_icon()
            if E.update_stats_ui then
                E.update_stats_ui()
            end
        end
        
        State.applying = false
        play_sound(Sounds.transform)
        Notify.show('Avatar Applied!', 'success')
    end)
end

function Av.apply_to_player(targetPlayer, avatarId, skipNotify)
    local char = targetPlayer.Character
    if not char or not char:FindFirstChild('HumanoidRootPart') then
        if not skipNotify then
            Notify.show('Player Has No Character', 'error')
        end
        return false
    end
    
    local id = resolve(avatarId)
    if not id then
        if not skipNotify then
            Notify.show('Avatar ID Not Found', 'error')
        end
        return false
    end
    
    local desc = Av.get_desc(id)
    if not desc then
        if not skipNotify then
            Notify.show('Failed To Fetch Avatar', 'error')
        end
        return false
    end
    
    local hum = char:FindFirstChildOfClass('Humanoid')
    if not hum then
        if not skipNotify then
            Notify.show('No Humanoid Found', 'error')
        end
        return false
    end
    
    if not State.player_original_descs[targetPlayer.UserId] then
        local original = hum:GetAppliedDescription()
        if original then
            State.player_original_descs[targetPlayer.UserId] = original
        end
    end
    
    local allowed = Av.build_allowed_from_userid(id)
    if allowed then
        Av.selective_cleanup(char, allowed)
    else
        Av.clean(char)
    end
    
    pcall(function()
        if hum.ApplyDescriptionClientServer then
            hum:ApplyDescriptionClientServer(desc)
        else
            hum:ApplyDescription(desc)
        end
    end)
    
    local bc = char:FindFirstChildOfClass('BodyColors')
    if not bc then
        bc = Instance.new('BodyColors')
        bc.Parent = char
    end
    
    bc.HeadColor3 = desc.HeadColor
    bc.TorsoColor3 = desc.TorsoColor
    bc.LeftArmColor3 = desc.LeftArmColor
    bc.RightArmColor3 = desc.RightArmColor
    bc.LeftLegColor3 = desc.LeftLegColor
    bc.RightLegColor3 = desc.RightLegColor
    
    local fields = {
        'HatAccessory', 'HairAccessory', 'FaceAccessory', 'NeckAccessory',
        'FrontAccessory', 'BackAccessory', 'WaistAccessory'
    }
    
    local total, loaded = 0, 0
    for _, f in ipairs(fields) do
        if desc[f] and desc[f] ~= '' then
            for _ in string.gmatch(desc[f], '%d+') do total = total + 1 end
        end
    end
    
    for _, f in ipairs(fields) do
        if desc[f] and desc[f] ~= '' then
            for aid in string.gmatch(desc[f], '%d+') do
                task.spawn(function()
                    local acc = Av.load_asset(tonumber(aid))
                    if acc and acc:IsA('Accessory') then
                        acc.Parent = char
                        hum:AddAccessory(acc)
                    end
                    loaded = loaded + 1
                end)
            end
        end
    end
    
    local t = 0
    while loaded < total and t < 2 do
        task.wait(0.02)
        t = t + 0.02
    end
    
    return true
end

function Av.apply_to_player_by_name(playerName, avatarId)
    if State.client_applying then
        return
    end
    State.client_applying = true
    
    task.spawn(function()
        local targetPlayer = nil
        for _, p in ipairs(Players:GetPlayers()) do
            if p.Name:lower() == playerName:lower() or p.DisplayName:lower() == playerName:lower() then
                targetPlayer = p
                break
            end
        end
        
        if not targetPlayer then
            State.client_applying = false
            Notify.show('Player Not Found', 'error')
            return
        end
        
        local success = Av.apply_to_player(targetPlayer, avatarId)
        State.client_applying = false
        
        if success then
            Notify.show('Applied To ' .. targetPlayer.Name .. '!', 'success')
        end
    end)
end

function Av.reset_player_avatar(playerName)
    local targetPlayer = nil
    for _, p in ipairs(Players:GetPlayers()) do
        if p.Name:lower() == playerName:lower() or p.DisplayName:lower() == playerName:lower() then
            targetPlayer = p
            break
        end
    end
    
    if not targetPlayer then
        Notify.show('Player Not Found', 'error')
        return
    end
    
    local char = targetPlayer.Character
    if not char then
        Notify.show('Player Has No Character', 'error')
        return
    end
    
    local hum = char:FindFirstChildOfClass('Humanoid')
    if not hum then
        Notify.show('No Humanoid Found', 'error')
        return
    end
    
    local originalDesc = State.player_original_descs[targetPlayer.UserId]
    if not originalDesc then
        local ok, desc = pcall(Players.GetHumanoidDescriptionFromUserId, Players, targetPlayer.UserId)
        if ok and desc then
            originalDesc = desc
        else
            Notify.show('No Original Avatar Saved', 'warning')
            return
        end
    end
    
    Av.clean(char)
    
    pcall(function()
        if hum.ApplyDescriptionClientServer then
            hum:ApplyDescriptionClientServer(originalDesc)
        else
            hum:ApplyDescription(originalDesc)
        end
    end)
    
    local fields = {
        'HatAccessory', 'HairAccessory', 'FaceAccessory', 'NeckAccessory',
        'FrontAccessory', 'BackAccessory', 'WaistAccessory'
    }
    
    for _, f in ipairs(fields) do
        if originalDesc[f] and originalDesc[f] ~= '' then
            for aid in string.gmatch(originalDesc[f], '%d+') do
                task.spawn(function()
                    local acc = Av.load_asset(tonumber(aid))
                    if acc and acc:IsA('Accessory') then
                        acc.Parent = char
                        hum:AddAccessory(acc)
                    end
                end)
            end
        end
    end
    
    State.player_original_descs[targetPlayer.UserId] = nil
    Notify.show('Reset ' .. targetPlayer.Name .. '!', 'success')
end

function Av.apply_to_all_players(avatarId)
    if State.client_applying then
        return
    end
    State.client_applying = true
    
    task.spawn(function()
        local id = resolve(avatarId)
        if not id then
            State.client_applying = false
            Notify.show('Avatar ID Not Found', 'error')
            return
        end
        
        local count = 0
        local players = Players:GetPlayers()
        
        for _, player in ipairs(players) do
            if player ~= LocalPlayer then
                local success = Av.apply_to_player(player, avatarId, true)
                if success then
                    count = count + 1
                end
                task.wait(0.05)
            end
        end
        
        State.client_applying = false
        Notify.show('Applied To ' .. count .. ' players!', 'success')
    end)
end

function Av.reset_all_players()
    if State.client_applying then
        return
    end
    State.client_applying = true
    
    task.spawn(function()
        local count = 0
        local players = Players:GetPlayers()
        
        for _, player in ipairs(players) do
            if player ~= LocalPlayer then
                local char = player.Character
                if char then
                    local hum = char:FindFirstChildOfClass('Humanoid')
                    if hum then
                        local originalDesc = State.player_original_descs[player.UserId]
                        if not originalDesc then
                            local ok, desc = pcall(Players.GetHumanoidDescriptionFromUserId, Players, player.UserId)
                            if ok and desc then
                                originalDesc = desc
                            end
                        end
                        
                        if originalDesc then
                            Av.clean(char)
                            
                            pcall(function()
                                if hum.ApplyDescriptionClientServer then
                                    hum:ApplyDescriptionClientServer(originalDesc)
                                else
                                    hum:ApplyDescription(originalDesc)
                                end
                            end)
                            
                            local fields = {
                                'HatAccessory', 'HairAccessory', 'FaceAccessory', 'NeckAccessory',
                                'FrontAccessory', 'BackAccessory', 'WaistAccessory'
                            }
                            
                            for _, f in ipairs(fields) do
                                if originalDesc[f] and originalDesc[f] ~= '' then
                                    for aid in string.gmatch(originalDesc[f], '%d+') do
                                        task.spawn(function()
                                            local acc = Av.load_asset(tonumber(aid))
                                            if acc and acc:IsA('Accessory') then
                                                acc.Parent = char
                                                hum:AddAccessory(acc)
                                            end
                                        end)
                                    end
                                end
                            end
                            
                            State.player_original_descs[player.UserId] = nil
                            count = count + 1
                        end
                    end
                end
                task.wait(0.05)
            end
        end
        
        State.client_applying = false
        Notify.show('Reset ' .. count .. ' players!', 'success')
    end)
end

function Av.protect(char, id)
    local db = false
    local hits = {}
    
    local conn = char.ChildAdded:Connect(function(child)
        if State.applying or db then
            return
        end
        if child:IsA('Tool') or child:IsA('HopperBin') then
            return
        end
        
        if child:IsA('Accessory') then
            table.insert(hits, tick())
            for i = #hits, 1, -1 do
                if tick() - hits[i] > 1 then
                    table.remove(hits, i)
                end
            end
            
            if #hits >= 5 and State.applied_id == id then
                db = true
                State.applied_id = nil
                Notify.show('Reapplying...', 'warning')
                Av.apply(tostring(id))
                task.delay(0.3, function()
                    db = false
                    hits = {}
                end)
            end
        end
    end)
    
    table.insert(State.conns, conn)
end

function Av.reset()
    if State.applying then
        return
    end
    if not State.original_desc then
        Notify.show('What We Trying?', 'warning')
        return
    end
    if not State.applied_id then
        Notify.show('Already At Original Avatar', 'info')
        return
    end
    
    State.applying = true
    task.spawn(function()
        local char = LocalPlayer.Character
        if not char or not char:FindFirstChild('HumanoidRootPart') then
            State.applying = false
            return
        end
        
        local hum = char:FindFirstChildOfClass('Humanoid')
        if not hum then
            State.applying = false
            return
        end
        
        local tools = {}
        for _, c in ipairs(char:GetChildren()) do
            if c:IsA('Tool') then
                table.insert(tools, c)
            end
        end
        
        local backpack = LocalPlayer:FindFirstChild('Backpack')
        if backpack then
            for _, t in ipairs(backpack:GetChildren()) do
                if t:IsA('Tool') then
                    table.insert(tools, t)
                end
            end
        end
        
        Av.clean(char)
        
        pcall(function()
            if hum.ApplyDescriptionClientServer then
                hum:ApplyDescriptionClientServer(State.original_desc)
            else
                hum:ApplyDescription(State.original_desc)
            end
        end)
        
        for _, t in ipairs(tools) do
            if t and t.Parent == nil then
                if backpack then
                    t.Parent = backpack
                else
                    t.Parent = char
                end
            end
        end
        
        State.applied_id = nil
        State.applying = false
        State.width_scale = 1
        State.width_enabled = false
        State.height_scale = 1
        State.height_enabled = false
        State.depth_scale = 1
        State.depth_enabled = false
        save_data()
        
        Fav.update_star_icon()
        Notify.show('Original Avatar Restored!', 'success')
    end)
end

local Auto = { running = false, thread = nil }

function Auto.start()
    if Auto.running then
        return
    end
    Auto.running = true
    
    Auto.thread = task.spawn(function()
        while Auto.running do
            if E.input.Text ~= '' and not State.applying and State.input_ready then
                local id = resolve(E.input.Text)
                if id and State.applied_id ~= id then
                    Av.apply(E.input.Text)
                end
                State.input_ready = false
            end
            task.wait(0.3)
        end
    end)
end

function Auto.stop()
    Auto.running = false
    if Auto.thread then
        task.cancel(Auto.thread)
        Auto.thread = nil
    end
end

local function get_preview_pos()
    local vp = workspace.CurrentCamera.ViewportSize
    local main_x = E.saved_pos.X.Offset
    local main_y = E.saved_pos.Y.Offset
    local main_w = E.main.AbsoluteSize.X
    local prev_w = 210
    local prev_h = 340
    
    local right_x = main_x + main_w + 12
    local left_x = main_x - prev_w - 12
    local can_right = right_x + prev_w <= vp.X - 10
    local can_left = left_x >= 10
    
    local x
    if State.client_preview_open then
        if can_right then
            x = right_x
        elseif can_left then
            x = left_x
        else
            x = vp.X - prev_w - 10
        end
    else
        if can_right then
            x = right_x
        elseif can_left then
            x = left_x
        else
            x = vp.X - prev_w - 10
        end
    end
    
    local y = main_y
    if y + prev_h > vp.Y - 10 then
        y = vp.Y - prev_h - 10
    end
    if y < 10 then
        y = 10
    end
    
    return UDim2.new(0, x, 0, y)
end

local function get_client_preview_pos()
    local vp = workspace.CurrentCamera.ViewportSize
    local main_x = E.saved_pos.X.Offset
    local main_y = E.saved_pos.Y.Offset
    local main_w = E.main.AbsoluteSize.X
    local prev_w = 210
    local prev_h = 340
    
    local right_x = main_x + main_w + 12
    local left_x = main_x - prev_w - 12
    local can_right = right_x + prev_w <= vp.X - 10
    local can_left = left_x >= 10
    
    local x
    if State.preview_open then
        if can_left then
            x = left_x
        elseif can_right then
            x = right_x
        else
            x = 10
        end
    else
        if can_left then
            x = left_x
        elseif can_right then
            x = right_x
        else
            x = 10
        end
    end
    
    local y = main_y
    if y + prev_h > vp.Y - 10 then
        y = vp.Y - prev_h - 10
    end
    if y < 10 then
        y = 10
    end
    
    return UDim2.new(0, x, 0, y)
end

local function update_fab_state(visible)
    tween(E.fab_indicator, { BackgroundColor3 = visible and C.success or C.error }, 0.15)
end

local function update_preview_icon()
    if E.prev_icon then
        tween(E.prev_icon, { ImageColor3 = State.preview_open and C.accent or C.subtext }, 0.15)
    end
end

local function update_client_preview_icon()
    if E.client_prev_icon then
        tween(E.client_prev_icon, { ImageColor3 = State.client_preview_open and C.accent or C.subtext }, 0.15)
    end
end

local function show_gui()
    State.visible = true
    update_fab_state(true)
    save_data()
    play_sound(Sounds.ui_toggle)
    
    local vp = workspace.CurrentCamera.ViewportSize
    local ui_w = IS_MOBILE and 280 or 340
    local ui_h = IS_MOBILE and 475 or 470
    local correct_size = State.minimized and UDim2.new(0, ui_w, 0, 52) or UDim2.new(0, ui_w, 0, ui_h)
    E.main.Size = correct_size
    E.main.Position = UDim2.new(0, E.saved_pos.X.Offset, 0, vp.Y + 50)
    E.main.Visible = true
    
    spring(E.main, { Position = E.saved_pos }, 0.35)
    
    if State.preview_open then
        local prev_pos = get_preview_pos()
        E.preview.Position = UDim2.new(0, prev_pos.X.Offset, 0, vp.Y + 50)
        E.preview.Visible = true
        task.spawn(function()
            spring(E.preview, { Position = prev_pos }, 0.35)
        end)
    end
    
    if State.client_preview_open then
        local prev_pos = get_client_preview_pos()
        E.client_preview.Position = UDim2.new(0, prev_pos.X.Offset, 0, vp.Y + 50)
        E.client_preview.Visible = true
        task.spawn(function()
            spring(E.client_preview, { Position = prev_pos }, 0.35)
        end)
    end
end

local function hide_gui()
    State.visible = false
    update_fab_state(false)
    save_data()
    play_sound(Sounds.ui_toggle)
    
    local vp = workspace.CurrentCamera.ViewportSize
    E.saved_pos = E.main.Position
    
    if State.preview_open then
        tween(E.preview, { Position = UDim2.new(0, E.preview.Position.X.Offset, 0, vp.Y + 50) }, 0.25, Enum.EasingStyle.Back, Enum.EasingDirection.In)
    end
    
    if State.client_preview_open then
        tween(E.client_preview, { Position = UDim2.new(0, E.client_preview.Position.X.Offset, 0, vp.Y + 50) }, 0.25, Enum.EasingStyle.Back, Enum.EasingDirection.In)
    end
    
    tween(E.main, { Position = UDim2.new(0, E.main.Position.X.Offset, 0, vp.Y + 50) }, 0.3, Enum.EasingStyle.Back, Enum.EasingDirection.In)
    
    task.delay(0.35, function()
        if not State.visible then
            E.main.Visible = false
            E.preview.Visible = false
            E.client_preview.Visible = false
        end
    end)
end

local function create_icon_btn(parent, ico, pos, size)
    size = size or 36
    local btn = new('TextButton', {
        Size = UDim2.new(0, size, 0, size),
        Position = pos,
        BackgroundColor3 = C.elevated,
        Text = '',
        AutoButtonColor = false,
        Parent = parent
    })
    corner(btn, 10)
    local ico_img = icon(btn, ico, 16, C.subtext)
    ico_img.ZIndex = 2
    
    btn.MouseEnter:Connect(function() tween(btn, { BackgroundColor3 = C.hover }, 0.1) end)
    btn.MouseLeave:Connect(function() tween(btn, { BackgroundColor3 = C.elevated }, 0.1) end)
    
    return btn, ico_img
end

local function create_button(parent, text, is_primary, order, ico)
    local btn = new('TextButton', {
        Size = UDim2.new(1, 0, 0, 44),
        BackgroundColor3 = is_primary and C.accent or C.elevated,
        Text = '',
        AutoButtonColor = false,
        LayoutOrder = order or 0,
        Parent = parent
    })
    corner(btn, 10)
    if not is_primary then
        stroke(btn, C.border, 1, 0.5)
    end
    
    local content = new('Frame', {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Parent = btn
    })
    
    if ico then
        icon(content, ico, 16, C.text, UDim2.new(0, 14, 0.5, -8))
        new('TextLabel', {
            Size = UDim2.new(1, -44, 1, 0),
            Position = UDim2.new(0, 38, 0, 0),
            BackgroundTransparency = 1,
            Text = text,
            TextColor3 = C.text,
            Font = Enum.Font.GothamBold,
            TextSize = 13,
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = content
        })
    else
        new('TextLabel', {
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Text = text,
            TextColor3 = C.text,
            Font = Enum.Font.GothamBold,
            TextSize = 13,
            Parent = content
        })
    end
    
    local hover = is_primary and C.accent_glow or C.hover
    local normal = is_primary and C.accent or C.elevated
    
    btn.MouseEnter:Connect(function() tween(btn, { BackgroundColor3 = hover }, 0.1) end)
    btn.MouseLeave:Connect(function() tween(btn, { BackgroundColor3 = normal }, 0.1) end)
    
    btn.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            spring(btn, { Size = UDim2.new(1, -4, 0, 40) }, 0.15)
        end
    end)
    
    btn.InputEnded:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            spring(btn, { Size = UDim2.new(1, 0, 0, 44) }, 0.15)
        end
    end)
    
    return btn
end

local function create_toggle(parent, text, initial, callback, order)
    local container = new('Frame', {
        Size = UDim2.new(1, 0, 0, 50),
        BackgroundColor3 = C.card,
        LayoutOrder = order or 0,
        Parent = parent
    })
    corner(container, 10)
    stroke(container, C.border, 1, 0.5)
    
    new('TextLabel', {
        Size = UDim2.new(1, -70, 1, 0),
        Position = UDim2.new(0, 16, 0, 0),
        BackgroundTransparency = 1,
        Text = text,
        TextColor3 = C.text,
        Font = Enum.Font.GothamSemibold,
        TextSize = 13,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = container
    })
    
    local track = new('Frame', {
        Size = UDim2.new(0, 48, 0, 26),
        Position = UDim2.new(1, -60, 0.5, -13),
        BackgroundColor3 = initial and C.accent or C.elevated,
        Parent = container
    })
    corner(track, 13)
    
    local knob = new('Frame', {
        Size = UDim2.new(0, 20, 0, 20),
        Position = initial and UDim2.new(1, -23, 0.5, -10) or UDim2.new(0, 3, 0.5, -10),
        BackgroundColor3 = C.text,
        Parent = track
    })
    corner(knob, 10)
    
    local enabled = initial
    
    container.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            enabled = not enabled
            tween(track, { BackgroundColor3 = enabled and C.accent or C.elevated }, 0.15)
            spring(knob, { Position = enabled and UDim2.new(1, -23, 0.5, -10) or UDim2.new(0, 3, 0.5, -10) }, 0.2)
            if callback then
                callback(enabled)
            end
        end
    end)
    
    return container, track, knob
end

function E.switch_tab(tab_id)
    State.current_tab = tab_id
    play_sound(Sounds.tab_switch)
    
    if tab_id == 'main' then
        E.main_content.Visible = true
        E.fav_content.Visible = false
        E.client_content.Visible = false
        E.settings_content.Visible = false
        E.input.Parent.Visible = true
        tween(E.main_tab_btn, { BackgroundColor3 = C.accent }, 0.15)
        tween(E.fav_tab_btn, { BackgroundColor3 = C.elevated }, 0.15)
        tween(E.client_tab_btn, { BackgroundColor3 = C.elevated }, 0.15)
        tween(E.settings_tab_btn, { BackgroundColor3 = C.elevated }, 0.15)
        tween(E.main_tab_icon, { ImageColor3 = C.text }, 0.15)
        tween(E.fav_tab_icon, { ImageColor3 = C.subtext }, 0.15)
        tween(E.client_tab_icon, { ImageColor3 = C.subtext }, 0.15)
        tween(E.settings_tab_icon, { ImageColor3 = C.subtext }, 0.15)
    elseif tab_id == 'favorites' then
        E.main_content.Visible = false
        E.fav_content.Visible = true
        E.client_content.Visible = false
        E.settings_content.Visible = false
        E.input.Parent.Visible = false
        tween(E.main_tab_btn, { BackgroundColor3 = C.elevated }, 0.15)
        tween(E.fav_tab_btn, { BackgroundColor3 = C.accent }, 0.15)
        tween(E.client_tab_btn, { BackgroundColor3 = C.elevated }, 0.15)
        tween(E.settings_tab_btn, { BackgroundColor3 = C.elevated }, 0.15)
        tween(E.main_tab_icon, { ImageColor3 = C.subtext }, 0.15)
        tween(E.fav_tab_icon, { ImageColor3 = C.text }, 0.15)
        tween(E.client_tab_icon, { ImageColor3 = C.subtext }, 0.15)
        tween(E.settings_tab_icon, { ImageColor3 = C.subtext }, 0.15)
        Fav.update_ui()
    elseif tab_id == 'client' then
        E.main_content.Visible = false
        E.fav_content.Visible = false
        E.client_content.Visible = true
        E.settings_content.Visible = false
        E.input.Parent.Visible = false
        tween(E.main_tab_btn, { BackgroundColor3 = C.elevated }, 0.15)
        tween(E.fav_tab_btn, { BackgroundColor3 = C.elevated }, 0.15)
        tween(E.client_tab_btn, { BackgroundColor3 = C.accent }, 0.15)
        tween(E.settings_tab_btn, { BackgroundColor3 = C.elevated }, 0.15)
        tween(E.main_tab_icon, { ImageColor3 = C.subtext }, 0.15)
        tween(E.fav_tab_icon, { ImageColor3 = C.subtext }, 0.15)
        tween(E.client_tab_icon, { ImageColor3 = C.text }, 0.15)
        tween(E.settings_tab_icon, { ImageColor3 = C.subtext }, 0.15)
    elseif tab_id == 'settings' then
        E.main_content.Visible = false
        E.fav_content.Visible = false
        E.client_content.Visible = false
        E.settings_content.Visible = true
        E.input.Parent.Visible = false
        tween(E.main_tab_btn, { BackgroundColor3 = C.elevated }, 0.15)
        tween(E.fav_tab_btn, { BackgroundColor3 = C.elevated }, 0.15)
        tween(E.client_tab_btn, { BackgroundColor3 = C.elevated }, 0.15)
        tween(E.settings_tab_btn, { BackgroundColor3 = C.accent }, 0.15)
        tween(E.main_tab_icon, { ImageColor3 = C.subtext }, 0.15)
        tween(E.fav_tab_icon, { ImageColor3 = C.subtext }, 0.15)
        tween(E.client_tab_icon, { ImageColor3 = C.subtext }, 0.15)
        tween(E.settings_tab_icon, { ImageColor3 = C.text }, 0.15)
    end
end

function E.build()
    local saved = load_data()
    
    State.auto = saved.auto or false
    State.minimized = saved.minimized or false
    State.visible = saved.visible ~= false
    State.favorites = saved.favorites or {}
    State.width_scale = saved.width_scale or 1
    State.width_enabled = saved.width_enabled or false
    State.height_scale = saved.height_scale or 1
    State.height_enabled = saved.height_enabled or false
    State.depth_scale = saved.depth_scale or 1
    State.depth_enabled = saved.depth_enabled or false
    State.music_index = saved.music_index or 1
    State.music_loop = saved.music_loop or false
    State.sound_effects_enabled = saved.sound_effects_enabled ~= false
    State.apply_counts = saved.apply_counts or {}
    
    local ui_width = IS_MOBILE and 280 or 340
    local ui_height = IS_MOBILE and 475 or 470
    local fab_size = IS_MOBILE and 50 or 56
    E.fab_size = fab_size
    
    local screen = new('ScreenGui', {
        Name = 'AvatarUI',
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        DisplayOrder = 999999,
        IgnoreGuiInset = true,
        Parent = PlayerGui
    })
    E.screen = screen
    
    local main = new('Frame', {
        Size = State.minimized and UDim2.new(0, ui_width, 0, 52) or UDim2.new(0, ui_width, 0, ui_height),
        Position = UDim2.new(0, saved.x or 100, 0, saved.y or 100),
        BackgroundColor3 = C.base,
        BackgroundTransparency = TRANSPARENCY,
        ClipsDescendants = true,
        Parent = screen
    })
    corner(main, State.minimized and 8 or 14)
    stroke(main, C.accent, 1.5, 0.6)
    E.main = main
    E.saved_pos = main.Position
    
    local header = new('Frame', {
        Size = UDim2.new(1, 0, 0, 52),
        BackgroundColor3 = C.panel,
        BackgroundTransparency = TRANSPARENCY,
        Parent = main
    })
    corner(header, State.minimized and 8 or 14)
    
    local header_extension = new('Frame', {
        Size = UDim2.new(1, 0, 0, 18),
        Position = UDim2.new(0, 0, 1, -18),
        BackgroundColor3 = C.panel,
        BackgroundTransparency = TRANSPARENCY,
        BorderSizePixel = 0,
        Visible = not State.minimized,
        Parent = header
    })
    E.header = header
    E.header_extension = header_extension
    
    new('TextLabel', {
        Size = UDim2.new(1, -100, 1, 0),
        Position = UDim2.new(0, 16, 0, 0),
        BackgroundTransparency = 1,
        Text = 'AVATAR CHANGER',
        TextColor3 = C.text,
        Font = Enum.Font.GothamBlack,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = header
    })
    
    E.star_btn, E.star_icon = create_icon_btn(header, Icons.heart_off, UDim2.new(1, -128, 0.5, -18))
    E.prev_btn, E.prev_icon = create_icon_btn(header, Icons.eye, UDim2.new(1, -86, 0.5, -18))
    E.min_btn = create_icon_btn(header, Icons.minus, UDim2.new(1, -44, 0.5, -18))
    
    local content_height = IS_MOBILE and 410 or 400
    local content = new('Frame', {
        Size = UDim2.new(1, -28, 0, content_height),
        Position = UDim2.new(0, 14, 0, 58),
        BackgroundTransparency = 1,
        ClipsDescendants = true,
        Visible = not State.minimized,
        Parent = main
    })
    
    new('UIListLayout', {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 10),
        Parent = content
    })
    E.content = content
    
    local tabs_frame = new('Frame', {
        Size = UDim2.new(1, 0, 0, 38),
        BackgroundTransparency = 1,
        LayoutOrder = 0.5,
        Parent = content
    })

    new('UIListLayout', {
        FillDirection = Enum.FillDirection.Horizontal,
        Padding = UDim.new(0, 8),
        Parent = tabs_frame
    })

    local function create_tab(ico_id, id, order)
        local btn = new('TextButton', {
            Size = UDim2.new(0.25, -6, 1, 0),
            BackgroundColor3 = C.elevated,
            Text = '',
            AutoButtonColor = false,
            LayoutOrder = order,
            Parent = tabs_frame
        })
        corner(btn, 8)
        
        local ico_img = icon(btn, ico_id, 18, C.subtext)
        
        btn.MouseEnter:Connect(function()
            if State.current_tab ~= id then
                tween(btn, { BackgroundColor3 = C.hover }, 0.1)
            end
        end)
        
        btn.MouseLeave:Connect(function()
            if State.current_tab ~= id then
                tween(btn, { BackgroundColor3 = C.elevated }, 0.1)
            end
        end)
        
        btn.InputBegan:Connect(function(inp)
            if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
                spring(btn, { Size = UDim2.new(0.25, -8, 1, -2) }, 0.1)
                E.switch_tab(id)
                task.delay(0.1, function()
                    spring(btn, { Size = UDim2.new(0.25, -6, 1, 0) }, 0.15)
                end)
            end
        end)
        
        return btn, ico_img
    end

    E.main_tab_btn, E.main_tab_icon = create_tab(Icons.home, 'main', 1)
    E.fav_tab_btn, E.fav_tab_icon = create_tab(Icons.bookmark, 'favorites', 2)
    E.client_tab_btn, E.client_tab_icon = create_tab(Icons.users, 'client', 3)
    E.settings_tab_btn, E.settings_tab_icon = create_tab(Icons.settings, 'settings', 4)
    
    local input_frame = new('Frame', {
        Size = UDim2.new(1, 0, 0, 48),
        BackgroundColor3 = C.card,
        LayoutOrder = 1,
        Parent = content
    })
    corner(input_frame, 10)
    stroke(input_frame, C.border, 1, 0.5)
    
    icon(input_frame, Icons.search, 16, C.muted, UDim2.new(0, 14, 0.5, -8))
    
    local input = new('TextBox', {
        Size = UDim2.new(1, -50, 1, 0),
        Position = UDim2.new(0, 40, 0, 0),
        BackgroundTransparency = 1,
        Text = saved.input or '',
        PlaceholderText = 'Search username or ID...',
        PlaceholderColor3 = C.muted,
        TextColor3 = C.text,
        Font = Enum.Font.GothamMedium,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        Parent = input_frame
    })
    E.input = input
    
    local main_content = new('Frame', {
        Size = UDim2.new(1, 0, 1, -98),
        Position = UDim2.new(0, 0, 0, 98),
        BackgroundTransparency = 1,
        Visible = true,
        LayoutOrder = 2,
        ZIndex = 1,
        Parent = content
    })

    local fav_content = new('Frame', {
        Size = UDim2.new(1, 0, 1, -50),
        Position = UDim2.new(0, 0, 0, 50),
        BackgroundTransparency = 1,
        Visible = false,
        LayoutOrder = 2,
        ZIndex = 2,
        Parent = content
    })
    
    new('UIListLayout', {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 10),
        Parent = fav_content
    })
    
    local fav_search_frame = new('Frame', {
        Size = UDim2.new(1, 0, 0, 42),
        BackgroundColor3 = C.card,
        LayoutOrder = 0,
        Parent = fav_content
    })
    corner(fav_search_frame, 10)
    stroke(fav_search_frame, C.border, 1, 0.5)
    
    icon(fav_search_frame, Icons.search, 14, C.muted, UDim2.new(0, 12, 0.5, -7))
    
    local fav_search_input = new('TextBox', {
        Size = UDim2.new(1, -40, 1, 0),
        Position = UDim2.new(0, 34, 0, 0),
        BackgroundTransparency = 1,
        Text = '',
        PlaceholderText = 'Search favorites...',
        PlaceholderColor3 = C.muted,
        TextColor3 = C.text,
        Font = Enum.Font.GothamMedium,
        TextSize = 13,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        Parent = fav_search_frame
    })
    E.fav_search_input = fav_search_input

    local fav_scroll = new('ScrollingFrame', {
        Size = UDim2.new(1, 0, 1, -50),
        Position = UDim2.new(0, 0, 0, 50),
        BackgroundTransparency = 1,
        ScrollBarThickness = 4,
        BorderSizePixel = 0,
        CanvasSize = UDim2.new(0, 0, 0, 0),
        LayoutOrder = 1,
        Parent = fav_content
    })

    new('UIListLayout', {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 10),
        Parent = fav_scroll
    })

    E.fav_list = fav_scroll
    E.main_content = main_content
    E.fav_content = fav_content

    local client_content = new('Frame', {
        Size = UDim2.new(1, 0, 1, -50),
        Position = UDim2.new(0, 0, 0, 50),
        BackgroundTransparency = 1,
        Visible = false,
        LayoutOrder = 2,
        ZIndex = 3,
        Parent = content
    })

    new('UIListLayout', {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 8),
        Parent = client_content
    })

    E.client_content = client_content
    
    local settings_content = new('Frame', {
        Size = UDim2.new(1, 0, 1, -50),
        Position = UDim2.new(0, 0, 0, 50),
        BackgroundTransparency = 1,
        Visible = false,
        LayoutOrder = 2,
        ZIndex = 4,
        Parent = content
    })
    
    local settings_scroll = new('ScrollingFrame', {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        ScrollBarThickness = 4,
        BorderSizePixel = 0,
        CanvasSize = UDim2.new(0, 0, 0, 0),
        Parent = settings_content
    })
    
    new('UIListLayout', {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 10),
        Parent = settings_scroll
    })
    
    E.settings_content = settings_content
    E.settings_scroll = settings_scroll
    
    local function create_body_scale_slider(parent, label_text, state_key, enabled_key, order)
        local frame = new('Frame', {
            Size = UDim2.new(1, -6, 0, 90),
            BackgroundColor3 = C.card,
            LayoutOrder = order,
            Parent = parent
        })
        corner(frame, 10)
        stroke(frame, C.border, 1, 0.5)

        new('TextLabel', {
            Size = UDim2.new(0.5, 0, 0, 20),
            Position = UDim2.new(0, 14, 0, 10),
            BackgroundTransparency = 1,
            Text = label_text,
            TextColor3 = C.text,
            Font = Enum.Font.GothamSemibold,
            TextSize = 13,
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = frame
        })

        local value_label = new('TextLabel', {
            Size = UDim2.new(0, 50, 0, 20),
            Position = UDim2.new(1, -64, 0, 10),
            BackgroundTransparency = 1,
            Text = math.floor((State[state_key] or 1) * 100) .. '%',
            TextColor3 = State[enabled_key] and C.accent or C.muted,
            Font = Enum.Font.GothamBold,
            TextSize = 13,
            TextXAlignment = Enum.TextXAlignment.Right,
            Parent = frame
        })

        local slider_bg = new('Frame', {
            Size = UDim2.new(1, -28, 0, 6),
            Position = UDim2.new(0, 14, 0, 42),
            BackgroundColor3 = C.elevated,
            Parent = frame
        })
        corner(slider_bg, 3)

        local slider_percent = math.clamp((State[state_key] - 0.5) / 1, 0, 1)
        
        local slider_fill = new('Frame', {
            Size = UDim2.new(slider_percent, 0, 1, 0),
            BackgroundColor3 = State[enabled_key] and C.accent or C.muted,
            Parent = slider_bg
        })
        corner(slider_fill, 3)

        local slider_handle = new('Frame', {
            Size = UDim2.new(0, 16, 0, 16),
            Position = UDim2.new(slider_percent, -8, 0.5, -8),
            BackgroundColor3 = C.text,
            ZIndex = 2,
            Parent = slider_bg
        })
        corner(slider_handle, 8)

        local toggle_frame = new('Frame', {
            Size = UDim2.new(1, -28, 0, 26),
            Position = UDim2.new(0, 14, 0, 56),
            BackgroundTransparency = 1,
            Parent = frame
        })
        
        new('TextLabel', {
            Size = UDim2.new(0.5, 0, 1, 0),
            BackgroundTransparency = 1,
            Text = 'Enable ' .. label_text,
            TextColor3 = C.subtext,
            Font = Enum.Font.GothamMedium,
            TextSize = 11,
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = toggle_frame
        })
        
        local toggle_track = new('Frame', {
            Size = UDim2.new(0, 42, 0, 22),
            Position = UDim2.new(1, -42, 0.5, -11),
            BackgroundColor3 = State[enabled_key] and C.accent or C.elevated,
            Parent = toggle_frame
        })
        corner(toggle_track, 11)
        
        local toggle_knob = new('Frame', {
            Size = UDim2.new(0, 16, 0, 16),
            Position = State[enabled_key] and UDim2.new(1, -19, 0.5, -8) or UDim2.new(0, 3, 0.5, -8),
            BackgroundColor3 = C.text,
            Parent = toggle_track
        })
        corner(toggle_knob, 8)
        
        toggle_frame.InputBegan:Connect(function(inp)
            if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
                State[enabled_key] = not State[enabled_key]
                tween(toggle_track, { BackgroundColor3 = State[enabled_key] and C.accent or C.elevated }, 0.15)
                spring(toggle_knob, { Position = State[enabled_key] and UDim2.new(1, -19, 0.5, -8) or UDim2.new(0, 3, 0.5, -8) }, 0.2)
                tween(slider_fill, { BackgroundColor3 = State[enabled_key] and C.accent or C.muted }, 0.15)
                tween(value_label, { TextColor3 = State[enabled_key] and C.accent or C.muted }, 0.15)
                
                if not State[enabled_key] then
                    State[state_key] = 1
                    local reset_percent = 0.5
                    tween(slider_fill, { Size = UDim2.new(reset_percent, 0, 1, 0) }, 0.2)
                    tween(slider_handle, { Position = UDim2.new(reset_percent, -8, 0.5, -8) }, 0.2)
                    value_label.Text = '100%'
                    
                    if State.applied_id then
                        local char = LocalPlayer.Character
                        if char then
                            local hum = char:FindFirstChildOfClass('Humanoid')
                            if hum then
                                pcall(function()
                                    local desc = hum:GetAppliedDescription()
                                    if desc then
                                        if state_key == 'width_scale' then
                                            desc.WidthScale = 1
                                        elseif state_key == 'height_scale' then
                                            desc.HeightScale = 1
                                        elseif state_key == 'depth_scale' then
                                            desc.DepthScale = 1
                                        end
                                        
                                        if hum.ApplyDescriptionClientServer then
                                            hum:ApplyDescriptionClientServer(desc)
                                        else
                                            hum:ApplyDescription(desc)
                                        end
                                    end
                                end)
                            end
                        end
                    end
                end
                
                if State.applied_id then
                    if State[enabled_key] then
                        Av.apply_body_scales()
                    end
                    Notify.show(label_text .. (State[enabled_key] and ' Enabled' or ' Disabled â†’ Reset To 100%'), State[enabled_key] and 'success' or 'info', 1.5)
                end
                save_data()
            end
        end)

        local dragging = false

        slider_bg.InputBegan:Connect(function(inp)
            if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
                dragging = true
            end
        end)

        table.insert(State.conns, UserInputService.InputChanged:Connect(function(inp)
            if not dragging then
                return
            end
            if inp.UserInputType ~= Enum.UserInputType.MouseMovement and inp.UserInputType ~= Enum.UserInputType.Touch then
                return
            end
            
            local mouse_pos = UserInputService:GetMouseLocation()
            local slider_pos = slider_bg.AbsolutePosition
            local slider_size = slider_bg.AbsoluteSize
            
            local relative_x = mouse_pos.X - slider_pos.X
            local percent = math.clamp(relative_x / slider_size.X, 0, 1)
            
            State[state_key] = 0.5 + (percent * 1)
            
            slider_fill.Size = UDim2.new(percent, 0, 1, 0)
            slider_handle.Position = UDim2.new(percent, -8, 0.5, -8)
            value_label.Text = math.floor(State[state_key] * 100) .. '%'
            
            if State.applied_id and State[enabled_key] then
                Av.apply_body_scales()
            end
        end))

        table.insert(State.conns, UserInputService.InputEnded:Connect(function(inp)
            if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
                if dragging then
                    dragging = false
                    save_data()
                end
            end
        end))
        
        return frame
    end
    
create_body_scale_slider(settings_scroll, 'Avatar Width', 'width_scale', 'width_enabled', 1)
create_body_scale_slider(settings_scroll, 'Avatar Height', 'height_scale', 'height_enabled', 2)
create_body_scale_slider(settings_scroll, 'Avatar Depth', 'depth_scale', 'depth_enabled', 3)

create_toggle(settings_scroll, 'Disable Sound Effects', not State.sound_effects_enabled, function(enabled)
    State.sound_effects_enabled = not enabled
    save_data()
    Notify.show('Sound Effects : ' .. (State.sound_effects_enabled and 'Enabled' or 'Disabled'), 'info', 2)
end, 4)

settings_scroll.CanvasSize = UDim2.new(0, 0, 0, 340)
    
    settings_scroll.CanvasSize = UDim2.new(0, 0, 0, 290)

    local player_input_container = new('Frame', {
        Size = UDim2.new(1, 0, 0, 48),
        BackgroundTransparency = 1,
        LayoutOrder = 1,
        Parent = client_content
    })
    
    local player_input_frame = new('Frame', {
        Size = UDim2.new(1, -46, 0, 48),
        BackgroundColor3 = C.card,
        Parent = player_input_container
    })
    corner(player_input_frame, 10)
    stroke(player_input_frame, C.border, 1, 0.5)

    icon(player_input_frame, Icons.user, 16, C.muted, UDim2.new(0, 14, 0.5, -8))

    local player_input = new('TextBox', {
        Size = UDim2.new(1, -50, 1, 0),
        Position = UDim2.new(0, 40, 0, 0),
        BackgroundTransparency = 1,
        Text = '',
        PlaceholderText = 'Player username...',
        PlaceholderColor3 = C.muted,
        TextColor3 = C.text,
        Font = Enum.Font.GothamMedium,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        Parent = player_input_frame
    })
    E.player_input = player_input

    local autocomplete_label = new('TextLabel', {
        Size = UDim2.new(1, -50, 1, 0),
        Position = UDim2.new(0, 40, 0, 0),
        BackgroundTransparency = 1,
        Text = '',
        TextColor3 = C.muted,
        TextTransparency = 0.6,
        Font = Enum.Font.GothamMedium,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 0,
        Parent = player_input_frame
    })

    local client_prev_btn, client_prev_icon = create_icon_btn(player_input_container, Icons.eye, UDim2.new(1, -38, 0, 6))
    E.client_prev_btn = client_prev_btn
    E.client_prev_icon = client_prev_icon

    local current_suggestion = ''

    player_input:GetPropertyChangedSignal('Text'):Connect(function()
        local input_text = player_input.Text:lower()
        if input_text == '' then
            autocomplete_label.Text = ''
            current_suggestion = ''
            return
        end
        
        local match = nil
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Name:lower():sub(1, #input_text) == input_text then
                match = player.Name
                break
            end
        end
        
        if match and #input_text < #match then
            current_suggestion = match
            autocomplete_label.Text = match
        else
            autocomplete_label.Text = ''
            current_suggestion = ''
        end
    end)

    player_input.FocusLost:Connect(function(enterPressed)
        if enterPressed and current_suggestion ~= '' then
            player_input.Text = current_suggestion
            autocomplete_label.Text = ''
            current_suggestion = ''
        end
    end)

    local client_input_frame = new('Frame', {
        Size = UDim2.new(1, 0, 0, 48),
        BackgroundColor3 = C.card,
        LayoutOrder = 2,
        Parent = client_content
    })
    corner(client_input_frame, 10)
    stroke(client_input_frame, C.border, 1, 0.5)

    icon(client_input_frame, Icons.search, 16, C.muted, UDim2.new(0, 14, 0.5, -8))

    local client_input = new('TextBox', {
        Size = UDim2.new(1, -50, 1, 0),
        Position = UDim2.new(0, 40, 0, 0),
        BackgroundTransparency = 1,
        Text = '',
        PlaceholderText = 'Avatar ID to apply...',
        PlaceholderColor3 = C.muted,
        TextColor3 = C.text,
        Font = Enum.Font.GothamMedium,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        Parent = client_input_frame
    })
    E.client_input = client_input

    client_input:GetPropertyChangedSignal('Text'):Connect(function()
        if State.client_preview_open then
            ClientPrev.load(client_input.Text)
        end
    end)

    local client_btn_row = new('Frame', {
        Size = UDim2.new(1, 0, 0, 44),
        BackgroundTransparency = 1,
        LayoutOrder = 3,
        Parent = client_content
    })

    new('UIListLayout', {
        FillDirection = Enum.FillDirection.Horizontal,
        Padding = UDim.new(0, 8),
        Parent = client_btn_row
    })

    local client_apply_wrap = new('Frame', {
        Size = UDim2.new(0.5, -4, 1, 0),
        BackgroundTransparency = 1,
        LayoutOrder = 1,
        Parent = client_btn_row
    })
    E.client_apply_btn = create_button(client_apply_wrap, 'APPLY', true, 0, Icons.play)

    local client_reset_wrap = new('Frame', {
        Size = UDim2.new(0.5, -4, 1, 0),
        BackgroundTransparency = 1,
        LayoutOrder = 2,
        Parent = client_btn_row
    })
    E.client_reset_btn = create_button(client_reset_wrap, 'RESET', false, 0, Icons.rotate)

    local client_all_row = new('Frame', {
        Size = UDim2.new(1, 0, 0, 44),
        BackgroundTransparency = 1,
        LayoutOrder = 4,
        Parent = client_content
    })

    new('UIListLayout', {
        FillDirection = Enum.FillDirection.Horizontal,
        Padding = UDim.new(0, 8),
        Parent = client_all_row
    })

    local client_apply_all_wrap = new('Frame', {
        Size = UDim2.new(0.5, -4, 1, 0),
        BackgroundTransparency = 1,
        LayoutOrder = 1,
        Parent = client_all_row
    })
    E.client_apply_all_btn = create_button(client_apply_all_wrap, 'APPLY ALL', false, 0, Icons.users)

    local client_reset_all_wrap = new('Frame', {
        Size = UDim2.new(0.5, -4, 1, 0),
        BackgroundTransparency = 1,
        LayoutOrder = 2,
        Parent = client_all_row
    })
    E.client_reset_all_btn = create_button(client_reset_all_wrap, 'RESET ALL', false, 0, Icons.refresh)

    new('UIListLayout', {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 10),
        Parent = main_content
    })

    local btn_row = new('Frame', {
        Size = UDim2.new(1, 0, 0, 48),
        BackgroundTransparency = 1,
        LayoutOrder = 2,
        Parent = main_content
    })

    new('UIListLayout', {
        FillDirection = Enum.FillDirection.Horizontal,
        Padding = UDim.new(0, 10),
        Parent = btn_row
    })

    local apply_wrap = new('Frame', {
        Size = UDim2.new(0.55, -5, 1, 0),
        BackgroundTransparency = 1,
        LayoutOrder = 1,
        Parent = btn_row
    })
    E.apply_btn = create_button(apply_wrap, 'APPLY', true, 0, Icons.play)

    local rand_wrap = new('Frame', {
        Size = UDim2.new(0.45, -5, 1, 0),
        BackgroundTransparency = 1,
        LayoutOrder = 2,
        Parent = btn_row
    })
    E.rand_btn = create_button(rand_wrap, 'RANDOM', false, 0, Icons.dice)

    local reset_row = new('Frame', {
        Size = UDim2.new(1, 0, 0, 44),
        BackgroundTransparency = 1,
        LayoutOrder = 3,
        Parent = main_content
    })

    local reset_wrap = new('Frame', {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Parent = reset_row
    })
    E.reset_btn = create_button(reset_wrap, 'RESET TO ORIGINAL', false, 0, Icons.rotate)

    new('Frame', {
        Size = UDim2.new(1, 0, 0, 1),
        BackgroundColor3 = C.border,
        BackgroundTransparency = 0.5,
        LayoutOrder = 4,
        Parent = main_content
    })

    local stats_container = new('ScrollingFrame', {
        Size = UDim2.new(1, 0, 0, 120),
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        ScrollBarThickness = 4,
        ScrollBarImageColor3 = C.accent,
        CanvasSize = UDim2.new(0, 0, 0, 0),
        AutomaticCanvasSize = Enum.AutomaticSize.Y,
        LayoutOrder = 4.5,
        Parent = main_content
    })
    
    local stats_layout = new('UIListLayout', {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 8),
        Parent = stats_container
    })
    
    local stats_header = new('Frame', {
        Size = UDim2.new(1, 0, 0, 24),
        BackgroundTransparency = 1,
        LayoutOrder = 1,
        Parent = stats_container
    })
    
    icon(stats_header, Icons.stats, 16, C.accent, UDim2.new(0, 0, 0.5, -8))
    
    new('TextLabel', {
        Size = UDim2.new(1, -24, 1, 0),
        Position = UDim2.new(0, 22, 0, 0),
        BackgroundTransparency = 1,
        Text = 'Most Applied Avatars',
        TextColor3 = C.text,
        Font = Enum.Font.GothamBold,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = stats_header
    })
    
    E.stats_list = new('Frame', {
        Size = UDim2.new(1, 0, 0, 0),
        AutomaticSize = Enum.AutomaticSize.Y,
        BackgroundTransparency = 1,
        LayoutOrder = 2,
        Parent = stats_container
    })
    
    new('UIListLayout', {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 6),
        Parent = E.stats_list
    })
    
    local function update_stats_ui()
        for _, c in ipairs(E.stats_list:GetChildren()) do
            if c:IsA('Frame') then
                c:Destroy()
            end
        end
        
        local sorted_stats = {}
        for id, count in pairs(State.apply_counts) do
            table.insert(sorted_stats, {id = tonumber(id), count = count})
        end
        table.sort(sorted_stats, function(a, b) return a.count > b.count end)
        
        local max_display = 5
        if #sorted_stats == 0 then
            local empty_label = new('TextLabel', {
                Size = UDim2.new(1, 0, 0, 60),
                BackgroundColor3 = C.card,
                Text = 'No avatars applied yet\nStart applying to see stats!',
                TextColor3 = C.muted,
                Font = Enum.Font.Gotham,
                TextSize = 12,
                TextWrapped = true,
                Parent = E.stats_list
            })
            corner(empty_label, 8)
            stroke(empty_label, C.border, 1, 0.5)
        else
            for i = 1, math.min(#sorted_stats, max_display) do
                local stat = sorted_stats[i]
                
                local rank_colors = {
                    Color3.fromRGB(255, 215, 0),
                    Color3.fromRGB(192, 192, 192),  
                    Color3.fromRGB(205, 127, 50)
                }
                
                local border_colors = {
                    Color3.fromRGB(255, 215, 0),
                    Color3.fromRGB(192, 192, 192),
                    Color3.fromRGB(205, 127, 50)
                }
                
                local stat_card = new('Frame', {
                    Size = UDim2.new(1, 0, 0, 32),
                    BackgroundColor3 = C.card,
                    LayoutOrder = i,
                    Parent = E.stats_list
                })
                corner(stat_card, 8)
                stroke(stat_card, border_colors[i], 1.5, 0.4)
                
                local rank_badge = new('TextLabel', {
                    Size = UDim2.new(0, 24, 0, 24),
                    Position = UDim2.new(0, 6, 0.5, -12),
                    BackgroundColor3 = rank_colors[i],
                    Text = tostring(i),
                    TextColor3 = i == 2 and Color3.fromRGB(40, 40, 40) or C.text,
                    Font = Enum.Font.GothamBold,
                    TextSize = 12,
                    Parent = stat_card
                })
                corner(rank_badge, 6)
                
                local id_label = new('TextLabel', {
                    Size = UDim2.new(0, 90, 1, 0),
                    Position = UDim2.new(0, 36, 0, 0),
                    BackgroundTransparency = 1,
                    Text = tostring(stat.id),
                    TextColor3 = C.text,
                    Font = Enum.Font.GothamMedium,
                    TextSize = 11,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    TextTruncate = Enum.TextTruncate.AtEnd,
                    Parent = stat_card
                })
                
                local count_label = new('TextLabel', {
                    Size = UDim2.new(0, 60, 1, 0),
                    Position = UDim2.new(0, 130, 0, 0),
                    BackgroundTransparency = 1,
                    Text = stat.count .. 'x',
                    TextColor3 = C.subtext,
                    Font = Enum.Font.GothamMedium,
                    TextSize = 11,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    Parent = stat_card
                })
                
                local quick_apply_btn = new('TextButton', {
                    Size = UDim2.new(0, 60, 0, 24),
                    Position = UDim2.new(1, -66, 0.5, -12),
                    BackgroundColor3 = C.elevated,
                    Text = 'APPLY',
                    TextColor3 = C.text,
                    Font = Enum.Font.GothamBold,
                    TextSize = 9,
                    AutoButtonColor = false,
                    Parent = stat_card
                })
                corner(quick_apply_btn, 6)
                local btn_stroke = stroke(quick_apply_btn, C.border, 1, 0.5)
                
                quick_apply_btn.InputBegan:Connect(function(inp)
                    if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
                        if State.stats_apply_cooldown then
                            return
                        end
                        State.stats_apply_cooldown = true
                        
                        for _, card in ipairs(E.stats_list:GetChildren()) do
                            if card:IsA('Frame') then
                                local btn = card:FindFirstChild('TextButton')
                                if btn then
                                    tween(btn, { BackgroundColor3 = C.muted }, 0.15)
                                    btn.Active = false
                                    local btn_st = btn:FindFirstChildOfClass('UIStroke')
                                    if btn_st then
                                        tween(btn_st, { Transparency = 0.7 }, 0.15)
                                    end
                                end
                            end
                        end
                        
                        local id_str = tostring(stat.id)
                        E.input.Text = id_str
                        State.input_ready = true
                        local was_applied = State.applied_id == stat.id
                        if was_applied then
                            State.applied_id = nil
                        end
                        Av.apply(id_str)
                        
                        task.delay(0.75, function()
                            State.stats_apply_cooldown = false
                            for _, card in ipairs(E.stats_list:GetChildren()) do
                                if card:IsA('Frame') then
                                    local btn = card:FindFirstChild('TextButton')
                                    if btn then
                                        tween(btn, { BackgroundColor3 = C.elevated }, 0.15)
                                        btn.Active = true
                                        local btn_st = btn:FindFirstChildOfClass('UIStroke')
                                        if btn_st then
                                            tween(btn_st, { Transparency = 0.5 }, 0.15)
                                        end
                                    end
                                end
                            end
                        end)
                    end
                end)
                
                quick_apply_btn.MouseEnter:Connect(function()
                    if not State.stats_apply_cooldown then
                        tween(quick_apply_btn, { BackgroundColor3 = C.hover }, 0.15)
                    end
                end)
                
                quick_apply_btn.MouseLeave:Connect(function()
                    if not State.stats_apply_cooldown then
                        tween(quick_apply_btn, { BackgroundColor3 = C.elevated }, 0.15)
                    end
                end)
            end
        end
    end
    
    E.update_stats_ui = update_stats_ui
    update_stats_ui()

    create_toggle(main_content, 'Auto Apply', State.auto, function(enabled)
        State.auto = enabled
        save_data()
        
        if enabled then
            Notify.show('Auto Apply Enabled', 'success', 2)
            Auto.start()
            E.reset_btn.BackgroundTransparency = 0.5
            E.reset_btn.Active = false
            if E.input.Text ~= '' then
                State.input_ready = true
            end
        else
            Notify.show('Auto Apply Disabled', 'info', 2)
            Auto.stop()
            E.reset_btn.BackgroundTransparency = 0
            E.reset_btn.Active = true
        end
    end, 5)
    
local music_frame = new('Frame', {
    Size = UDim2.new(1, 0, 0, 138),
    BackgroundColor3 = C.card,
    LayoutOrder = 5,
    Parent = client_content
})
corner(music_frame, 10)
stroke(music_frame, C.border, 1, 0.5)

new('TextLabel', {
    Size = UDim2.new(1, -28, 0, 18),
    Position = UDim2.new(0, 14, 0, 8),
    BackgroundTransparency = 1,
    Text = 'â™« Music Player',
    TextColor3 = C.text,
    Font = Enum.Font.GothamSemibold,
    TextSize = 13,
    TextXAlignment = Enum.TextXAlignment.Left,
    Parent = music_frame
})

local music_name_label = new('TextLabel', {
    Size = UDim2.new(1, -28, 0, 16),
    Position = UDim2.new(0, 14, 0, 28),
    BackgroundTransparency = 1,
    Text = Music[State.music_index].name,
    TextColor3 = C.accent,
    Font = Enum.Font.GothamMedium,
    TextSize = 12,
    TextXAlignment = Enum.TextXAlignment.Left,
    TextTruncate = Enum.TextTruncate.AtEnd,
    Parent = music_frame
})
E.music_name_label = music_name_label

local progress_container = new('Frame', {
    Size = UDim2.new(1, -28, 0, 32),
    Position = UDim2.new(0, 14, 0, 48),
    BackgroundTransparency = 1,
    Parent = music_frame
})

local time_current = new('TextLabel', {
    Size = UDim2.new(0, 40, 0, 14),
    Position = UDim2.new(0, 0, 0, 0),
    BackgroundTransparency = 1,
    Text = '0:00',
    TextColor3 = C.subtext,
    Font = Enum.Font.GothamMedium,
    TextSize = 10,
    TextXAlignment = Enum.TextXAlignment.Left,
    Parent = progress_container
})
E.time_current = time_current

local time_total = new('TextLabel', {
    Size = UDim2.new(0, 40, 0, 14),
    Position = UDim2.new(1, -40, 0, 0),
    BackgroundTransparency = 1,
    Text = '0:00',
    TextColor3 = C.subtext,
    Font = Enum.Font.GothamMedium,
    TextSize = 10,
    TextXAlignment = Enum.TextXAlignment.Right,
    Parent = progress_container
})
E.time_total = time_total

local function format_time(seconds)
    local mins = math.floor(seconds / 60)
    local secs = math.floor(seconds % 60)
    return string.format('%d:%02d', mins, secs)
end

local progress_bg = new('Frame', {
    Size = UDim2.new(1, -90, 0, 4),
    Position = UDim2.new(0, 45, 0, 18),
    BackgroundColor3 = C.elevated,
    Parent = progress_container
})
corner(progress_bg, 2)

local progress_dragging = false

progress_bg.InputBegan:Connect(function(inp)
    if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
        if State.music_sound then
            progress_dragging = true
            
            local mouse_pos = UserInputService:GetMouseLocation()
            local bar_pos = progress_bg.AbsolutePosition
            local bar_size = progress_bg.AbsoluteSize
            
            local relative_x = mouse_pos.X - bar_pos.X
            local percent = math.clamp(relative_x / bar_size.X, 0, 1)
            
            local new_time = percent * State.music_sound.TimeLength
            State.music_sound.TimePosition = new_time
            
            E.progress_fill.Size = UDim2.new(percent, 0, 1, 0)
            E.progress_handle.Position = UDim2.new(percent, -5, 0.5, -5)
            E.time_current.Text = format_time(new_time)
        end
    end
end)

table.insert(State.conns, UserInputService.InputChanged:Connect(function(inp)
    if not progress_dragging then
        return
    end
    if inp.UserInputType ~= Enum.UserInputType.MouseMovement and inp.UserInputType ~= Enum.UserInputType.Touch then
        return
    end
    
    if State.music_sound then
        local mouse_pos = UserInputService:GetMouseLocation()
        local bar_pos = progress_bg.AbsolutePosition
        local bar_size = progress_bg.AbsoluteSize
        
        local relative_x = mouse_pos.X - bar_pos.X
        local percent = math.clamp(relative_x / bar_size.X, 0, 1)
        
        local new_time = percent * State.music_sound.TimeLength
        State.music_sound.TimePosition = new_time
        
        E.progress_fill.Size = UDim2.new(percent, 0, 1, 0)
        E.progress_handle.Position = UDim2.new(percent, -5, 0.5, -5)
        E.time_current.Text = format_time(new_time)
    end
end))

table.insert(State.conns, UserInputService.InputEnded:Connect(function(inp)
    if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
        progress_dragging = false
    end
end))

local progress_fill = new('Frame', {
    Size = UDim2.new(0, 0, 1, 0),
    BackgroundColor3 = C.accent,
    Parent = progress_bg
})
corner(progress_fill, 2)
E.progress_fill = progress_fill

local progress_handle = new('Frame', {
    Size = UDim2.new(0, 10, 0, 10),
    Position = UDim2.new(0, -5, 0.5, -5),
    BackgroundColor3 = C.text,
    ZIndex = 2,
    Parent = progress_bg
})
corner(progress_handle, 5)
E.progress_handle = progress_handle

local music_controls = new('Frame', {
    Size = UDim2.new(1, -28, 0, 28),
    Position = UDim2.new(0, 14, 0, 84),
    BackgroundTransparency = 1,
    Parent = music_frame
})

new('UIListLayout', {
    FillDirection = Enum.FillDirection.Horizontal,
    Padding = UDim.new(0, 35),
    Parent = music_controls
})

local prev_music_btn = new('TextButton', {
    Size = UDim2.new(0, 28, 0, 28),
    BackgroundColor3 = C.elevated,
    Text = '',
    AutoButtonColor = false,
    Parent = music_controls
})
corner(prev_music_btn, 6)
icon(prev_music_btn, Icons.chevron_left, 16, C.text)

local play_pause_btn = new('TextButton', {
    Size = UDim2.new(0, 28, 0, 28),
    BackgroundColor3 = C.accent,
    Text = '',
    AutoButtonColor = false,
    Parent = music_controls
})
corner(play_pause_btn, 6)
local play_icon = icon(play_pause_btn, Icons.play, 14, C.text)
E.music_play_icon = play_icon

local next_music_btn = new('TextButton', {
    Size = UDim2.new(0, 28, 0, 28),
    BackgroundColor3 = C.elevated,
    Text = '',
    AutoButtonColor = false,
    Parent = music_controls
})
corner(next_music_btn, 6)
icon(next_music_btn, Icons.chevron_right, 16, C.text)

local loop_btn = new('TextButton', {
    Size = UDim2.new(0, 28, 0, 28),
    BackgroundColor3 = State.music_loop and C.accent or C.elevated,
    Text = '',
    AutoButtonColor = false,
    Parent = music_controls
})
corner(loop_btn, 6)
local loop_icon = icon(loop_btn, Icons.refresh, 14, State.music_loop and C.text or C.muted)
E.music_loop_btn = loop_btn
E.music_loop_icon = loop_icon

local music_ended_conn = nil
local music_update_conn = nil
local stop_music, pause_music, resume_music, play_music, next_track, prev_track, update_progress

update_progress = function()
    if not State.music_sound or not State.music_sound.IsPlaying then
        return
    end
    local current = State.music_sound.TimePosition
    local total = State.music_sound.TimeLength
    if total > 0 then
        local progress = current / total
        E.progress_fill.Size = UDim2.new(progress, 0, 1, 0)
        E.progress_handle.Position = UDim2.new(progress, -5, 0.5, -5)
        E.time_current.Text = format_time(current)
        E.time_total.Text = format_time(total)
    end
end

stop_music = function()
    if State.music_sound then
        State.music_sound:Stop()
        State.music_sound:Destroy()
        State.music_sound = nil
    end
    
    if music_ended_conn then
        music_ended_conn:Disconnect()
        music_ended_conn = nil
    end
    
    if music_update_conn then
        music_update_conn:Disconnect()
        music_update_conn = nil
    end
    
    State.music_playing = false
    play_icon.Image = Icons.play
    tween(play_pause_btn, { BackgroundColor3 = C.accent }, 0.2)
    E.progress_fill.Size = UDim2.new(0, 0, 1, 0)
    E.progress_handle.Position = UDim2.new(0, -5, 0.5, -5)
    E.time_current.Text = '0:00'
    E.time_total.Text = '0:00'
end

pause_music = function()
    if State.music_sound and State.music_sound.IsPlaying then
        State.music_sound:Pause()
    end
    State.music_playing = false
    play_icon.Image = Icons.play
    tween(play_pause_btn, { BackgroundColor3 = C.accent }, 0.2)
    update_progress()
end

resume_music = function()
    if State.music_sound and not State.music_sound.IsPlaying then
        State.music_sound:Resume()
        State.music_playing = true
        play_icon.Image = Icons.x
        tween(play_pause_btn, { BackgroundColor3 = C.success }, 0.2)
    end
end

next_track = function()
    State.music_index = State.music_index + 1
    if State.music_index > #Music then
        State.music_index = 1
    end
    local was_playing = State.music_playing
    stop_music()
    music_name_label.Text = Music[State.music_index].name
    if was_playing then
        play_music()
    end
    save_data()
end

prev_track = function()
    State.music_index = State.music_index - 1
    if State.music_index < 1 then
        State.music_index = #Music
    end
    local was_playing = State.music_playing
    stop_music()
    music_name_label.Text = Music[State.music_index].name
    if was_playing then
        play_music()
    end
    save_data()
end

play_music = function()
    if State.music_sound and not State.music_sound.IsPlaying then
        resume_music()
        return
    end
    
    stop_music()
    
    State.music_sound = Instance.new('Sound')
    State.music_sound.SoundId = Music[State.music_index].id
    State.music_sound.Volume = 0.3
    State.music_sound.Looped = State.music_loop
    State.music_sound.Parent = workspace
    
    if not State.music_loop then
        music_ended_conn = State.music_sound.Ended:Connect(function()
            if State.music_playing then
                task.wait(0.1)
                next_track()
            end
        end)
    end
    
    State.music_sound:Play()
    State.music_playing = true
    play_icon.Image = Icons.x
    tween(play_pause_btn, { BackgroundColor3 = C.success }, 0.2)
    music_name_label.Text = Music[State.music_index].name
    
    task.spawn(function()
        task.wait(0.1)
        if State.music_sound then
            E.time_total.Text = format_time(State.music_sound.TimeLength)
        end
    end)
    
    if music_update_conn then
        music_update_conn:Disconnect()
    end
    music_update_conn = game:GetService('RunService').RenderStepped:Connect(function()
        if State.music_playing and State.music_sound and State.music_sound.IsPlaying then
            update_progress()
        end
    end)
    table.insert(State.conns, music_update_conn)
end

play_pause_btn.InputBegan:Connect(function(inp)
    if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
        if State.music_playing then
            pause_music()
        else
            play_music()
        end
    end
end)

next_music_btn.InputBegan:Connect(function(inp)
    if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
        next_track()
    end
end)

prev_music_btn.InputBegan:Connect(function(inp)
    if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
        prev_track()
    end
end)

loop_btn.InputBegan:Connect(function(inp)
    if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
        State.music_loop = not State.music_loop
        tween(loop_btn, { BackgroundColor3 = State.music_loop and C.accent or C.elevated }, 0.2)
        tween(loop_icon, { ImageColor3 = State.music_loop and C.text or C.muted }, 0.2)
        
        if State.music_sound then
            State.music_sound.Looped = State.music_loop
            
            if music_ended_conn then
                music_ended_conn:Disconnect()
                music_ended_conn = nil
            end
            
            if not State.music_loop then
                music_ended_conn = State.music_sound.Ended:Connect(function()
                    if State.music_playing then
                        task.wait(0.1)
                        next_track()
                    end
                end)
            end
        end
        
        Notify.show('Loop : ' .. (State.music_loop and 'ON (Current track)' or 'OFF (Auto-advance)'), 'info', 2)
        save_data()
    end
end)

    
    local sfx_toggle_frame = new('Frame', {
        Size = UDim2.new(1, -28, 0, 24),
        Position = UDim2.new(0, 14, 1, -27),
        BackgroundTransparency = 1,
        Parent = music_frame
    })
    
    local preview = new('Frame', {
        Size = UDim2.new(0, 210, 0, 410),
        BackgroundColor3 = C.base,
        BackgroundTransparency = TRANSPARENCY,
        Visible = false,
        Parent = screen
    })
    corner(preview, 14)
    stroke(preview, C.accent, 1.5, 0.6)
    E.preview = preview
    
    local pv_header = new('Frame', {
        Size = UDim2.new(1, 0, 0, 46),
        BackgroundColor3 = C.panel,
        BackgroundTransparency = TRANSPARENCY,
        Parent = preview
    })
    corner(pv_header, 14)
    
    new('Frame', {
        Size = UDim2.new(1, 0, 0, 14),
        Position = UDim2.new(0, 0, 1, -14),
        BackgroundColor3 = C.panel,
        BackgroundTransparency = TRANSPARENCY,
        BorderSizePixel = 0,
        Parent = pv_header
    })
    
    icon(pv_header, Icons.eye, 16, C.subtext, UDim2.new(0, 14, 0.5, -8))
    
    new('TextLabel', {
        Size = UDim2.new(1, -50, 1, 0),
        Position = UDim2.new(0, 38, 0, 0),
        BackgroundTransparency = 1,
        Text = 'PREVIEW',
        TextColor3 = C.text,
        Font = Enum.Font.GothamBold,
        TextSize = 13,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = pv_header
    })
    
    local vp_container = new('Frame', {
        Size = UDim2.new(1, -20, 0, 195),
        Position = UDim2.new(0, 10, 0, 54),
        BackgroundColor3 = C.card,
        Parent = preview
    })
    corner(vp_container, 10)
    
    local viewport = new('ViewportFrame', {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Ambient = Color3.fromRGB(100, 100, 100),
        LightColor = Color3.fromRGB(255, 255, 255),
        LightDirection = Vector3.new(-1, -1, -1),
        Parent = vp_container
    })
    corner(viewport, 10)
    E.viewport = viewport
    
    local vp_label = new('TextLabel', {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Text = 'Enter ID',
        TextColor3 = C.muted,
        Font = Enum.Font.GothamMedium,
        TextSize = 12,
        Parent = vp_container
    })
    E.vp_label = vp_label
    
    local ctrl_row = new('Frame', {
        Size = UDim2.new(1, -20, 0, 38),
        Position = UDim2.new(0, 10, 0, 257),
        BackgroundTransparency = 1,
        Parent = preview
    })
    
    new('UIListLayout', {
        FillDirection = Enum.FillDirection.Horizontal,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        Padding = UDim.new(0, 8),
        Parent = ctrl_row
    })
    
    local function pv_ctrl_btn(ico, ord)
        local b = new('TextButton', {
            Size = UDim2.new(0, 55, 0, 36),
            BackgroundColor3 = C.elevated,
            Text = '',
            AutoButtonColor = false,
            LayoutOrder = ord,
            Parent = ctrl_row
        })
        corner(b, 10)
        icon(b, ico, 16, C.text)
        
        b.MouseEnter:Connect(function() tween(b, { BackgroundColor3 = C.hover }, 0.1) end)
        b.MouseLeave:Connect(function() tween(b, { BackgroundColor3 = C.elevated }, 0.1) end)
        
        return b
    end
    
    E.rot_l = pv_ctrl_btn(Icons.chevron_left, 1)
    E.rot_reset = pv_ctrl_btn(Icons.rotate, 2)
    E.rot_r = pv_ctrl_btn(Icons.chevron_right, 3)
    
    local zoom_row = new('Frame', {
        Size = UDim2.new(1, -20, 0, 38),
        Position = UDim2.new(0, 10, 0, 303),
        BackgroundTransparency = 1,
        Parent = preview
    })
    
    new('UIListLayout', {
        FillDirection = Enum.FillDirection.Horizontal,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        Padding = UDim.new(0, 8),
        Parent = zoom_row
    })
    
    local function zoom_ctrl_btn(ico, ord)
        local b = new('TextButton', {
            Size = UDim2.new(0, 55, 0, 36),
            BackgroundColor3 = C.elevated,
            Text = '',
            AutoButtonColor = false,
            LayoutOrder = ord,
            Parent = zoom_row
        })
        corner(b, 10)
        icon(b, ico, 16, C.text)
        
        b.MouseEnter:Connect(function() tween(b, { BackgroundColor3 = C.hover }, 0.1) end)
        b.MouseLeave:Connect(function() tween(b, { BackgroundColor3 = C.elevated }, 0.1) end)
        
        return b
    end
    
    E.zoom_out_btn = zoom_ctrl_btn(Icons.minus, 1)
    E.zoom_in_btn = zoom_ctrl_btn(Icons.plus, 2)
    
    local vp_user = new('TextLabel', {
        Size = UDim2.new(1, -20, 0, 22),
        Position = UDim2.new(0, 10, 0, 352),
        BackgroundTransparency = 1,
        Text = '',
        TextColor3 = C.text,
        Font = Enum.Font.GothamBold,
        TextSize = 14,
        TextTruncate = Enum.TextTruncate.AtEnd,
        Parent = preview
    })
    E.vp_user = vp_user
    
    local vp_details = new('TextLabel', {
        Size = UDim2.new(1, -20, 0, 18),
        Position = UDim2.new(0, 10, 0, 377),
        BackgroundTransparency = 1,
        Text = '',
        TextColor3 = C.subtext,
        Font = Enum.Font.GothamMedium,
        TextSize = 11,
        TextTruncate = Enum.TextTruncate.AtEnd,
        Parent = preview
    })
    E.vp_details = vp_details

    local client_preview = new('Frame', {
        Size = UDim2.new(0, 210, 0, 410),
        BackgroundColor3 = C.base,
        BackgroundTransparency = TRANSPARENCY,
        Visible = false,
        Parent = screen
    })
    corner(client_preview, 14)
    stroke(client_preview, C.warning, 1.5, 0.6)
    E.client_preview = client_preview
    
    local cpv_header = new('Frame', {
        Size = UDim2.new(1, 0, 0, 46),
        BackgroundColor3 = C.panel,
        BackgroundTransparency = TRANSPARENCY,
        Parent = client_preview
    })
    corner(cpv_header, 14)
    
    new('Frame', {
        Size = UDim2.new(1, 0, 0, 14),
        Position = UDim2.new(0, 0, 1, -14),
        BackgroundColor3 = C.panel,
        BackgroundTransparency = TRANSPARENCY,
        BorderSizePixel = 0,
        Parent = cpv_header
    })
    
    icon(cpv_header, Icons.users, 16, C.warning, UDim2.new(0, 14, 0.5, -8))
    
    new('TextLabel', {
        Size = UDim2.new(1, -50, 1, 0),
        Position = UDim2.new(0, 38, 0, 0),
        BackgroundTransparency = 1,
        Text = 'CLIENT',
        TextColor3 = C.text,
        Font = Enum.Font.GothamBold,
        TextSize = 13,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = cpv_header
    })
    
    local cvp_container = new('Frame', {
        Size = UDim2.new(1, -20, 0, 195),
        Position = UDim2.new(0, 10, 0, 54),
        BackgroundColor3 = C.card,
        Parent = client_preview
    })
    corner(cvp_container, 10)
    
    local client_viewport = new('ViewportFrame', {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Ambient = Color3.fromRGB(100, 100, 100),
        LightColor = Color3.fromRGB(255, 255, 255),
        LightDirection = Vector3.new(-1, -1, -1),
        Parent = cvp_container
    })
    corner(client_viewport, 10)
    E.client_viewport = client_viewport
    
    local client_vp_label = new('TextLabel', {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Text = 'Enter ID',
        TextColor3 = C.muted,
        Font = Enum.Font.GothamMedium,
        TextSize = 12,
        Parent = cvp_container
    })
    E.client_vp_label = client_vp_label
    
    local c_ctrl_row = new('Frame', {
        Size = UDim2.new(1, -20, 0, 38),
        Position = UDim2.new(0, 10, 0, 257),
        BackgroundTransparency = 1,
        Parent = client_preview
    })
    
    new('UIListLayout', {
        FillDirection = Enum.FillDirection.Horizontal,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        Padding = UDim.new(0, 8),
        Parent = c_ctrl_row
    })
    
    local function cpv_ctrl_btn(ico, ord)
        local b = new('TextButton', {
            Size = UDim2.new(0, 55, 0, 36),
            BackgroundColor3 = C.elevated,
            Text = '',
            AutoButtonColor = false,
            LayoutOrder = ord,
            Parent = c_ctrl_row
        })
        corner(b, 10)
        icon(b, ico, 16, C.text)
        
        b.MouseEnter:Connect(function() tween(b, { BackgroundColor3 = C.hover }, 0.1) end)
        b.MouseLeave:Connect(function() tween(b, { BackgroundColor3 = C.elevated }, 0.1) end)
        
        return b
    end
    
    E.c_rot_l = cpv_ctrl_btn(Icons.chevron_left, 1)
    E.c_rot_reset = cpv_ctrl_btn(Icons.rotate, 2)
    E.c_rot_r = cpv_ctrl_btn(Icons.chevron_right, 3)
    
    local c_zoom_row = new('Frame', {
        Size = UDim2.new(1, -20, 0, 38),
        Position = UDim2.new(0, 10, 0, 303),
        BackgroundTransparency = 1,
        Parent = client_preview
    })
    
    new('UIListLayout', {
        FillDirection = Enum.FillDirection.Horizontal,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        Padding = UDim.new(0, 8),
        Parent = c_zoom_row
    })
    
    local function c_zoom_ctrl_btn(ico, ord)
        local b = new('TextButton', {
            Size = UDim2.new(0, 55, 0, 36),
            BackgroundColor3 = C.elevated,
            Text = '',
            AutoButtonColor = false,
            LayoutOrder = ord,
            Parent = c_zoom_row
        })
        corner(b, 10)
        icon(b, ico, 16, C.text)
        
        b.MouseEnter:Connect(function() tween(b, { BackgroundColor3 = C.hover }, 0.1) end)
        b.MouseLeave:Connect(function() tween(b, { BackgroundColor3 = C.elevated }, 0.1) end)
        
        return b
    end
    
    E.c_zoom_out_btn = c_zoom_ctrl_btn(Icons.minus, 1)
    E.c_zoom_in_btn = c_zoom_ctrl_btn(Icons.plus, 2)
    
    local client_vp_user = new('TextLabel', {
        Size = UDim2.new(1, -20, 0, 22),
        Position = UDim2.new(0, 10, 0, 352),
        BackgroundTransparency = 1,
        Text = '',
        TextColor3 = C.text,
        Font = Enum.Font.GothamBold,
        TextSize = 14,
        TextTruncate = Enum.TextTruncate.AtEnd,
        Parent = client_preview
    })
    E.client_vp_user = client_vp_user

    local fab = new('TextButton', {
        Size = UDim2.new(0, fab_size, 0, fab_size),
        Position = UDim2.new(0, saved.fab_x or 16, 0, saved.fab_y or (workspace.CurrentCamera.ViewportSize.Y / 2 - fab_size / 2)),
        BackgroundColor3 = C.elevated,
        Text = '',
        AutoButtonColor = false,
        Parent = screen
    })
    corner(fab, math.floor(fab_size / 4))
    stroke(fab, C.border, 1.5, 0.4)
    E.fab = fab

    local fab_indicator = new('Frame', {
        Size = UDim2.new(0, 9, 0, 9),
        Position = UDim2.new(1, -14, 0, 8),
        BackgroundColor3 = State.visible and C.success or C.error,
        Parent = fab
    })
    corner(fab_indicator, 5)
    E.fab_indicator = fab_indicator

    local fab_icon_container = new('Frame', {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Parent = fab
    })

    icon(fab_icon_container, Icons.eye, IS_MOBILE and 22 or 26, C.text)

    fab.MouseEnter:Connect(function()
        if not IS_MOBILE then
            tween(fab, { BackgroundColor3 = C.hover }, 0.1)
        end
    end)

    fab.MouseLeave:Connect(function()
        if not IS_MOBILE then
            tween(fab, { BackgroundColor3 = C.elevated }, 0.1)
        end
    end)
    
    E.setup_events()
    
    if State.minimized then
        main.Size = UDim2.new(0, ui_width, 0, 52)
        content.Visible = false
        E.min_btn:FindFirstChildOfClass('ImageLabel').Image = Icons.plus
    end

    main.Position = clamp_frame(main)
    E.saved_pos = main.Position

    if not State.visible then
        main.Visible = false
        update_fab_state(false)
    else
        update_fab_state(true)
    end

    if State.auto then
        Auto.start()
        E.reset_btn.BackgroundTransparency = 0.5
        E.reset_btn.Active = false
        if E.input.Text ~= '' then
            State.input_ready = true
        end
    end

    E.switch_tab('main')
    Fav.update_star_icon()
end

function E.setup_events()
    local dragging = false
    local drag_start, start_pos
    
    E.star_btn.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            if not State.applied_id then
                Notify.show('Apply An Avatar First!', 'warning')
                return
            end
            
            spring(E.star_icon, { Rotation = 360 }, 0.25)
            task.delay(0.25, function() E.star_icon.Rotation = 0 end)
            
            Fav.toggle(State.applied_id)
        end
    end)
    
    E.header.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            drag_start = inp.Position
            start_pos = E.main.Position
        end
    end)
    
    table.insert(State.conns, UserInputService.InputChanged:Connect(function(inp)
        if not dragging then
            return
        end
        if inp.UserInputType ~= Enum.UserInputType.MouseMovement and inp.UserInputType ~= Enum.UserInputType.Touch then
            return
        end
        
        local delta = inp.Position - drag_start
        E.main.Position = UDim2.new(0, start_pos.X.Offset + delta.X, 0, start_pos.Y.Offset + delta.Y)
        E.saved_pos = E.main.Position
        
        if State.preview_open and E.preview.Visible then
            E.preview.Position = get_preview_pos()
        end
        if State.client_preview_open and E.client_preview.Visible then
            E.client_preview.Position = get_client_preview_pos()
        end
    end))
    
    table.insert(State.conns, UserInputService.InputEnded:Connect(function(inp)
        if inp.UserInputType ~= Enum.UserInputType.MouseButton1 and inp.UserInputType ~= Enum.UserInputType.Touch then
            return
        end
        
        if dragging then
            dragging = false
            local clamped_pos = clamp_frame(E.main, true)
            tween(E.main, { Position = clamped_pos }, 0.2, Enum.EasingStyle.Quint)
            E.saved_pos = clamped_pos
            
            if State.preview_open and E.preview.Visible then
                tween(E.preview, { Position = get_preview_pos() }, 0.2, Enum.EasingStyle.Quint)
            end
            if State.client_preview_open and E.client_preview.Visible then
                tween(E.client_preview, { Position = get_client_preview_pos() }, 0.2, Enum.EasingStyle.Quint)
            end
            save_data()
        end
    end))
    
    local fab_dragging = false
    local fab_drag_start, fab_start_pos
    local fab_moved = false
    local fab_press_time = 0

    E.fab.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            fab_dragging = true
            fab_moved = false
            fab_press_time = tick()
            fab_drag_start = inp.Position
            fab_start_pos = E.fab.Position
            
            tween(E.fab, { Size = UDim2.new(0, E.fab_size - 6, 0, E.fab_size - 6) }, 0.08)
            tween(E.fab, { BackgroundColor3 = C.hover }, 0.08)
        end
    end)

    table.insert(State.conns, UserInputService.InputChanged:Connect(function(inp)
        if not fab_dragging then
            return
        end
        if inp.UserInputType ~= Enum.UserInputType.MouseMovement and inp.UserInputType ~= Enum.UserInputType.Touch then
            return
        end
        
        local delta = inp.Position - fab_drag_start
        if math.abs(delta.X) > 5 or math.abs(delta.Y) > 5 then
            fab_moved = true
            E.fab.Position = UDim2.new(0, fab_start_pos.X.Offset + delta.X, 0, fab_start_pos.Y.Offset + delta.Y)
            
            if E.fab.AbsoluteSize.X < E.fab_size then
                spring(E.fab, { Size = UDim2.new(0, E.fab_size, 0, E.fab_size) }, 0.1)
            end
        end
    end))

    table.insert(State.conns, UserInputService.InputEnded:Connect(function(inp)
        if inp.UserInputType ~= Enum.UserInputType.MouseButton1 and inp.UserInputType ~= Enum.UserInputType.Touch then
            return
        end
        
        if fab_dragging then
            fab_dragging = false
            
            spring(E.fab, { Size = UDim2.new(0, E.fab_size, 0, E.fab_size) }, 0.15)
            tween(E.fab, { BackgroundColor3 = C.elevated }, 0.15)
            
            local vp = workspace.CurrentCamera.ViewportSize
            local new_x = math.clamp(E.fab.Position.X.Offset, 10, vp.X - E.fab_size - 10)
            local new_y = math.clamp(E.fab.Position.Y.Offset, 10, vp.Y - E.fab_size - 10)
            
            spring(E.fab, { Position = UDim2.new(0, new_x, 0, new_y) }, 0.2)
            save_data()
            
            local hold_time = tick() - fab_press_time
            if not fab_moved and hold_time < 0.3 then
                if State.fab_toggle_cooldown then
                    return
                end
                State.fab_toggle_cooldown = true
                
                tween(E.fab, { Size = UDim2.new(0, E.fab_size + 8, 0, E.fab_size + 8) }, 0.08)
                task.delay(0.08, function()
                    spring(E.fab, { Size = UDim2.new(0, E.fab_size, 0, E.fab_size) }, 0.15)
                end)
                
                if State.visible then
                    hide_gui()
                else
                    show_gui()
                end
                
                task.delay(0.35, function() State.fab_toggle_cooldown = false end)
            end
        end
    end))
    
    E.prev_btn.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            play_sound(Sounds.button_click)
            State.preview_open = not State.preview_open
            update_preview_icon()
            
            if State.preview_open then
                local pos = get_preview_pos()
                local vp = workspace.CurrentCamera.ViewportSize
                
                E.preview.Position = UDim2.new(0, pos.X.Offset, 0, vp.Y + 50)
                E.preview.Visible = true
                
                spring(E.preview, { Position = pos }, 0.3)
                Prev.load(E.input.Text)
            else
                local vp = workspace.CurrentCamera.ViewportSize
                tween(E.preview, { Position = UDim2.new(0, E.preview.Position.X.Offset, 0, vp.Y + 50) }, 0.2, Enum.EasingStyle.Back, Enum.EasingDirection.In)
                
                task.delay(0.25, function()
                    if not State.preview_open then
                        E.preview.Visible = false
                        Prev.clear()
                    end
                end)
            end
        end
    end)
    
    E.client_prev_btn.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            play_sound(Sounds.button_click)
            State.client_preview_open = not State.client_preview_open
            update_client_preview_icon()
            
            if State.client_preview_open then
                local pos = get_client_preview_pos()
                local vp = workspace.CurrentCamera.ViewportSize
                
                E.client_preview.Position = UDim2.new(0, pos.X.Offset, 0, vp.Y + 50)
                E.client_preview.Visible = true
                
                spring(E.client_preview, { Position = pos }, 0.3)
                ClientPrev.load(E.client_input.Text)
            else
                local vp = workspace.CurrentCamera.ViewportSize
                tween(E.client_preview, { Position = UDim2.new(0, E.client_preview.Position.X.Offset, 0, vp.Y + 50) }, 0.2, Enum.EasingStyle.Back, Enum.EasingDirection.In)
                
                task.delay(0.25, function()
                    if not State.client_preview_open then
                        E.client_preview.Visible = false
                        ClientPrev.clear()
                    end
                end)
            end
        end
    end)
    
    E.min_btn.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            play_sound(Sounds.button_click)
            State.minimized = not State.minimized
            
            local img = E.min_btn:FindFirstChildOfClass('ImageLabel')
            img.Image = State.minimized and Icons.plus or Icons.minus
            
            local ui_w = IS_MOBILE and 280 or 340
            local ui_h = IS_MOBILE and 475 or 470
            local target_size = State.minimized and UDim2.new(0, ui_w, 0, 52) or UDim2.new(0, ui_w, 0, ui_h)
            
            E.content.Visible = not State.minimized
            if E.header_extension then
                E.header_extension.Visible = not State.minimized
            end
            
            local main_corner = E.main:FindFirstChildOfClass('UICorner')
            local header_corner = E.main:FindFirstChild('Frame') and E.main:FindFirstChild('Frame'):FindFirstChildOfClass('UICorner')
            
            if State.minimized then
                if main_corner then
                    tween(main_corner, { CornerRadius = UDim.new(0, 8) }, 0.2)
                end
                if header_corner then
                    tween(header_corner, { CornerRadius = UDim.new(0, 8) }, 0.2)
                end
            else
                if main_corner then
                    tween(main_corner, { CornerRadius = UDim.new(0, 14) }, 0.2)
                end
                if header_corner then
                    tween(header_corner, { CornerRadius = UDim.new(0, 14) }, 0.2)
                end
            end
            
            tween(E.main, { Size = target_size }, 0.2, Enum.EasingStyle.Quint)
            save_data()
        end
    end)
    
    E.apply_btn.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            if State.applying then
                return
            end
            if E.input.Text == '' then
                Notify.show('Enter Username or ID', 'warning')
                return
            end
            play_sound(Sounds.click)
            Av.apply(E.input.Text)
        end
    end)
    
    E.rand_btn.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            if State.applying or State.random_cooldown then
                return
            end
            State.random_cooldown = true
            play_sound(Sounds.dice)
            
            local pool = {}
            for _, id in ipairs(Presets) do
                if not table.find(State.randoms, id) then
                    table.insert(pool, id)
                end
            end
            
            if #pool == 0 then
                State.randoms = {}
                pool = Presets
            end
            
            local pick = pool[math.random(#pool)]
            table.insert(State.randoms, pick)
            
            E.input.Text = tostring(pick)
            save_data()
            State.input_ready = true
            Notify.show('Random : ' .. pick, 'info', 2)
            
            task.delay(0.3, function() State.random_cooldown = false end)
        end
    end)
    
    E.reset_btn.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            if State.auto then
                Notify.show('Disable Auto Apply First', 'warning')
                return
            end
            play_sound(Sounds.reset)
            Av.reset()
        end
    end)
    
    E.client_apply_btn.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            if State.client_applying then
                return
            end
            
            local playerName = E.player_input.Text
            local avatarId = E.client_input.Text
            
            if playerName == '' then
                Notify.show('Enter Player Name', 'warning')
                return
            end
            
            if avatarId == '' then
                Notify.show('Enter Avatar ID', 'warning')
                return
            end
            
            Av.apply_to_player_by_name(playerName, avatarId)
        end
    end)
    
    E.client_reset_btn.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            local playerName = E.player_input.Text
            
            if playerName == '' then
                Notify.show('Enter Player Name', 'warning')
                return
            end
            
            Av.reset_player_avatar(playerName)
        end
    end)
    
    E.client_apply_all_btn.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            if State.client_applying then
                return
            end
            
            local avatarId = E.client_input.Text
            
            if avatarId == '' then
                Notify.show('Enter Avatar ID', 'warning')
                return
            end
            
            Av.apply_to_all_players(avatarId)
        end
    end)
    
    E.client_reset_all_btn.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            if State.client_applying then
                return
            end
            Av.reset_all_players()
        end
    end)
    
    E.input.FocusLost:Connect(function(enterPressed)
        save_data()
        if E.input.Text ~= '' then
            State.input_ready = true
        end
        if State.preview_open then
            Prev.load(E.input.Text)
        end
    end)
    
    E.input:GetPropertyChangedSignal('Text'):Connect(function()
        State.input_ready = false
        if State.preview_open then
            Prev.load(E.input.Text)
        end
        Fav.update_star_icon()
    end)
    
    E.rot_l.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            Prev.rot = Prev.rot - 45
            Prev.update()
        end
    end)
    
    E.rot_r.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            Prev.rot = Prev.rot + 45
            Prev.update()
        end
    end)
    
    E.rot_reset.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            Prev.rot = 180
            State.zoom_level = 5.5
            Prev.update()
        end
    end)
    
    E.zoom_in_btn.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            State.zoom_level = math.max(2, State.zoom_level - 0.5)
            Prev.update()
        end
    end)
    
    E.zoom_out_btn.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            State.zoom_level = math.min(10, State.zoom_level + 0.5)
            Prev.update()
        end
    end)
    
    if E.fav_search_input then
        E.fav_search_input:GetPropertyChangedSignal('Text'):Connect(function()
            State.fav_search_text = E.fav_search_input.Text
            Fav.update_ui()
        end)
    end
    
    E.c_rot_l.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            ClientPrev.rot = ClientPrev.rot - 45
            ClientPrev.update()
        end
    end)
    
    E.c_rot_r.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            ClientPrev.rot = ClientPrev.rot + 45
            ClientPrev.update()
        end
    end)
    
    E.c_rot_reset.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            ClientPrev.rot = 180
            State.client_zoom_level = 5.5
            ClientPrev.update()
        end
    end)
    
    E.c_zoom_in_btn.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            State.client_zoom_level = math.max(2, State.client_zoom_level - 0.5)
            ClientPrev.update()
        end
    end)
    
    E.c_zoom_out_btn.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
            State.client_zoom_level = math.min(10, State.client_zoom_level + 0.5)
            ClientPrev.update()
        end
    end)
    
    table.insert(State.conns, workspace.CurrentCamera:GetPropertyChangedSignal('ViewportSize'):Connect(function()
        if E.main and E.main.Visible then
            E.main.Position = clamp_frame(E.main, State.preview_open)
            E.saved_pos = E.main.Position
            if State.preview_open and E.preview.Visible then
                E.preview.Position = get_preview_pos()
            end
            if State.client_preview_open and E.client_preview.Visible then
                E.client_preview.Position = get_client_preview_pos()
            end
        end
    end))
    
    table.insert(State.conns, LocalPlayer.CharacterAdded:Connect(function(char)
        State.applied_id = nil
        char:WaitForChild('Humanoid')
        char:WaitForChild('HumanoidRootPart')
        task.wait(0.15)
        
        State.input_ready = true
        Fav.update_star_icon()
    end))
end

E.build()
warn('[AVATAR CHANGER] Loaded Successfully!')
